<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>NJR — Pay (TON Connect)</title>

  <!-- 1) CSS : جرّب تحميل محلياً أولاً (أفضل داخل public/) -->
  <link rel="stylesheet" href="/tonconnect-ui.min.css">

  <!-- 2) تحميل SDK ثم UI من ملفات محلية داخل public/ (أو استخدم CDN إذا لم تنجح محلياً) -->
  <!-- ضع هذه الملفات في public/: tonconnect-sdk.min.js و tonconnect-ui.min.js -->
  <script src="/tonconnect-sdk.min.js"></script>
  <script src="/tonconnect-ui.min.js"></script>

  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#0f0b14;color:#fff;padding:18px}
    .card{max-width:520px;margin:36px auto;background:linear-gradient(180deg,#241731,#37243a);padding:18px;border-radius:12px;text-align:center}
    .btn{padding:12px 18px;border-radius:10px;background:#2d9cdb;color:#fff;font-weight:700;border:none;cursor:pointer}
    .btn.secondary{background:#6b46d6}
    .info{color:#cfc1e8;margin:10px 0}
    .log{margin-top:10px;color:#a9a0c6;font-size:13px;white-space:pre-wrap;text-align:left;max-height:220px;overflow:auto;padding:8px;background:rgba(255,255,255,0.02);border-radius:8px}
  </style>
</head>
<body>
  <div class="card">
    <h2 id="title">Buy Boost ×2</h2>
    <div id="desc" class="info">Connecting wallet...</div>
    <div id="price" style="font-weight:800;font-size:20px;margin:8px 0"></div>

    <div style="display:flex;gap:8px;justify-content:center;margin-top:12px">
      <button id="connectBtn" class="btn">Connect Wallet</button>
      <button id="openFallback" class="btn secondary">Open Tonkeeper (fallback)</button>
    </div>

    <div id="msg" class="info"></div>
    <div id="log" class="log" aria-live="polite"></div>
  </div>

  <!-- (fallback modal omitted here for brevity; keep your existing modal if you want) -->

<script>
/*
  Initialization assumptions:
  - public/tonconnect-sdk.min.js exposes global TonConnectSDK (or window.TonConnect)
  - public/tonconnect-ui.min.js exposes global TonConnectUI or TON_CONNECT_UI
  - public/tonconnect-ui.min.css is available
*/

(async function(){
  const logEl = document.getElementById('log');
  const msgEl = document.getElementById('msg');
  function log(...a){ console.log(...a); if(logEl) logEl.innerText += a.map(x=> typeof x === 'object' ? JSON.stringify(x) : String(x)).join(' ') + "\n"; }
  function setMsg(t){ if(msgEl) msgEl.innerText = t; }

  // Check SDK/UI availability (they were included via script tags in head)
  log('globals presence', {
    TonConnectSDK: !!window.TonConnectSDK,
    TonConnect: !!window.TonConnect,
    TonConnectUI: !!window.TonConnectUI,
    TON_CONNECT_UI: !!window.TON_CONNECT_UI
  });

  // Use the known global names (try multiple)
  const SDKGlobal = window.TonConnectSDK || window.TonConnect || (window.TonConnectSDK ? window.TonConnectSDK : null);
  const UIGlobal = window.TonConnectUI || window.TON_CONNECT_UI || null;

  if(!SDKGlobal){
    log('TonConnect SDK not loaded. Ensure public/tonconnect-sdk.min.js exists and is the correct UMD.');
    setMsg('SDK missing - use fallback');
    return;
  }

  const manifestUrl = `${location.origin}/tonconnect-manifest.json`;
  // create TonConnect instance
  let tonConnect;
  try {
    const TonCtor = SDKGlobal.TonConnect || SDKGlobal;
    tonConnect = new TonCtor({ manifestUrl });
    window.tonConnect = tonConnect;
    log('tonConnect created');
  } catch(e){
    log('tonConnect create error', e);
    setMsg('TonConnect init failed - fallback only');
    return;
  }

  // create UI instance only when UIGlobal exists
  let tonConnectUI = null;
  if(UIGlobal){
    try {
      const UIctor = UIGlobal.TonConnectUI || UIGlobal;
      tonConnectUI = new UIctor({ tonConnect });
      window.tonConnectUI = tonConnectUI;
      log('tonConnectUI created');
    } catch(e){
      log('tonConnectUI init error', e);
    }
  } else {
    log('TonConnectUI global not found - UI modal unavailable');
  }

  // create invoice (same as your server flow)
  const params = new URLSearchParams(location.search);
  const item = params.get('item') || 'boost_x2_1h';
  const user = params.get('user') || '';

  async function createInvoice(){
    try {
      const r = await fetch('/pay/create', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ user_id:user, item }) });
      const j = await r.json();
      log('createInvoice', j);
      return j;
    } catch(e){ log('createInvoice err', e); return { success:false }; }
  }

  const invoice = await createInvoice();
  if(!invoice.success){ setMsg('Invoice creation failed'); return; }
  window.invoice = invoice;
  document.getElementById('price').innerText = `Price: ${invoice.amount} TON`;
  setMsg('Ready — click Connect Wallet');

  // Helper to request tx
  async function requestSendTransaction(provider){
    try {
      const to = invoice.address;
      const value = String(Math.round(Number(invoice.amount) * 1e9));
      const comment = invoice.comment;
      const tx = { to, value, text: comment };
      log('requestSendTransaction', tx);
      setMsg('Requesting transaction in wallet...');
      await provider.request({ method:'ton_sendTransaction', params: [tx] });
      setMsg('Transaction requested — waiting for confirmation...');
    } catch(e){
      log('requestSendTransaction error', e);
      setMsg('Transaction request failed');
    }
  }

  // Connect button - call tonConnectUI.open() (this must show the TapSwap-like chooser)
  document.getElementById('connectBtn').addEventListener('click', async ()=>{
    const btn = document.getElementById('connectBtn'); btn.disabled = true;
    setMsg('Opening wallet chooser...');
    try {
      if(tonConnectUI && typeof tonConnectUI.open === 'function'){
        // open TonConnect UI chooser
        try {
          tonConnectUI.open();
          log('tonConnectUI.open() called');
        } catch(e){
          log('tonConnectUI.open() failed', e);
        }
      } else {
        // if UI not available, try tonConnect.connect() (may open wallet if provider supports)
        try { await tonConnect.connect(); log('tonConnect.connect() called'); } catch(e){ log('tonConnect.connect rejected', e); }
      }

      // wait for provider to appear (user selected a wallet). If provider appears, call requestSendTransaction.
      const waitForProvider = async (timeoutMs = 8000) => {
        const step = 300; let waited = 0;
        while(waited < timeoutMs){
          if((window.tonConnect && window.tonConnect.provider) || (window.TonConnect && window.TonConnect.provider)) return true;
          await new Promise(r=>setTimeout(r, step));
          waited += step;
        }
        return false;
      };

      const ok = await waitForProvider(8000);
      if(ok){
        setMsg('Wallet connected — sending transaction...');
        const provider = (window.tonConnect && window.tonConnect.provider) || (window.TonConnect && window.TonConnect.provider);
        if(provider) await requestSendTransaction(provider);
        else setMsg('Connected but provider object missing — try fallback');
      } else {
        setMsg('No wallet provider detected — use fallback chooser');
        // optionally show your fallback modal here (openTonChooser(window.invoice))
        if(typeof window.openTonChooser === 'function') window.openTonChooser(window.invoice);
      }

    } catch(e){
      log('connect handler error', e);
      setMsg('Connection failed - use fallback');
    } finally {
      btn.disabled = false;
    }
  });

  // fallback external button (Tonkeeper)
  document.getElementById('openFallback').addEventListener('click', ()=>{
    const tonKeeperUrl = `https://app.tonkeeper.com/transfer/${encodeURIComponent(invoice.address)}?amount=${Math.round(Number(invoice.amount)*1e9)}&text=${encodeURIComponent(invoice.comment)}`;
    try { if(window.Telegram && window.Telegram.WebApp && typeof window.Telegram.WebApp.openLink === 'function') window.Telegram.WebApp.openLink(tonKeeperUrl); else window.open(tonKeeperUrl, '_blank'); } catch(e){ window.open(tonKeeperUrl, '_blank'); }
  });

})();
</script>
</body>
</html>
