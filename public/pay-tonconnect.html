<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>NJR — Pay (TON Connect)</title>

  <!-- نستخدم ملف CSS محلي أولاً (public/tonconnect-ui.min.css) -->
  <link rel="stylesheet" href="/tonconnect-ui.min.css" id="tonconnect-ui-css"/>

  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#0f0b14;color:#fff;padding:18px}
    .card{max-width:520px;margin:36px auto;background:linear-gradient(180deg,#241731,#37243a);padding:18px;border-radius:12px;text-align:center}
    .btn{padding:12px 18px;border-radius:10px;background:#2d9cdb;color:#fff;font-weight:700;border:none;cursor:pointer}
    .btn.secondary{background:#6b46d6}
    .info{color:#cfc1e8;margin:10px 0}
    .log{margin-top:10px;color:#a9a0c6;font-size:13px;white-space:pre-wrap;text-align:left;max-height:200px;overflow:auto;padding:8px;background:rgba(255,255,255,0.02);border-radius:8px}
  </style>
</head>
<body>
  <div class="card">
    <h2 id="title">Buy Boost ×2</h2>
    <div id="desc" class="info">Connecting wallet...</div>
    <div id="price" style="font-weight:800;font-size:20px;margin:8px 0"></div>

    <div style="display:flex;gap:8px;justify-content:center;margin-top:12px">
      <button id="connectBtn" class="btn">Connect Wallet</button>
      <button id="openFallback" class="btn secondary">Open Tonkeeper (fallback)</button>
    </div>

    <div id="msg" class="info"></div>
    <div id="log" class="log" aria-live="polite"></div>
  </div>

<script>
(async function(){
  const logEl = document.getElementById('log');
  const msgEl = document.getElementById('msg');
  function log(...args){ console.log(...args); logEl.innerText += args.map(x=> typeof x === 'object' ? JSON.stringify(x) : String(x)).join(' ') + "\n"; }
  function setMsg(t){ msgEl.innerText = t; }

  // helper to load script
  function loadScript(src){
    return new Promise((resolve,reject)=>{
      const s = document.createElement('script');
      s.src = src;
      s.async = true;
      s.onload = ()=>{ log('loaded', src); resolve(); };
      s.onerror = (e)=>{ log('failed to load', src); reject(new Error('Failed load '+src));};
      document.head.appendChild(s);
    });
  }

  // file names to try (local first, then CDN fallback)
  const localSDK = '/tonconnect-sdk.min.js';
  const localUI = '/tonconnect-ui.min.js';
  const cdnSDK_unpkg = 'https://unpkg.com/@tonconnect/sdk@latest/dist/tonconnect-sdk.min.js';
  const cdnSDK_jsdelivr = 'https://cdn.jsdelivr.net/npm/@tonconnect/sdk@latest/dist/tonconnect-sdk.min.js';
  const cdnUI_unpkg = 'https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js';
  const cdnUI_jsdelivr = 'https://cdn.jsdelivr.net/npm/@tonconnect/ui@latest/dist/tonconnect-ui.min.js';
  const cdnCSS_unpkg = 'https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.css';
  const localCSS = '/tonconnect-ui.min.css';

  // ensure CSS available: try HEAD local then fallback to CDN
  try {
    const cssHref = document.getElementById('tonconnect-ui-css')?.getAttribute('href') || localCSS;
    log('css href', cssHref);
    const r = await fetch(cssHref, { method:'HEAD' });
    if(!r.ok) throw new Error('css not found');
    log('CSS exists:', cssHref);
  } catch(e){
    log('CSS missing locally, using CDN', e.message);
    document.getElementById('tonconnect-ui-css').setAttribute('href', cdnCSS_unpkg);
  }

  // load SDK
  let sdkLoaded = false;
  try {
    log('Trying local SDK', localSDK);
    await loadScript(localSDK);
    sdkLoaded = true;
  } catch(e){
    log('local SDK failed, trying unpkg', e.message);
    try { await loadScript(cdnSDK_unpkg); sdkLoaded = true; }
    catch(e2){ log('unpkg SDK failed, trying jsdelivr', e2.message);
      try { await loadScript(cdnSDK_jsdelivr); sdkLoaded = true; } catch(e3){ log('jsdelivr SDK failed', e3.message); }
    }
  }

  // load UI
  let uiLoaded = false;
  try {
    log('Trying local UI', localUI);
    await loadScript(localUI);
    uiLoaded = true;
  } catch(e){
    log('local UI failed, trying unpkg', e.message);
    try { await loadScript(cdnUI_unpkg); uiLoaded = true; }
    catch(e2){ log('unpkg UI failed, trying jsdelivr', e2.message);
      try { await loadScript(cdnUI_jsdelivr); uiLoaded = true; } catch(e3){ log('jsdelivr UI failed', e3.message); }
    }
  }

  log('load result', { sdkLoaded, uiLoaded });

  // check manifest
  const manifestUrl = `${location.origin}/tonconnect-manifest.json`;
  try {
    const r = await fetch(manifestUrl);
    if(!r.ok) throw new Error('manifest not found '+r.status);
    log('manifest OK', manifestUrl);
  } catch(e){
    log('manifest error', e.message);
    setMsg('Manifest not found — check /tonconnect-manifest.json');
  }

  // detect globals (SDK exposes TonConnectSDK, UI exposes TonConnectUI or TON_CONNECT_UI)
  log('window keys', { TonConnectSDK: !!window.TonConnectSDK, TonConnect: !!window.TonConnect, TonConnectUI: !!window.TonConnectUI, TON_CONNECT_UI: !!window.TON_CONNECT_UI });
  const TonConnectSDKGlobal = window.TonConnectSDK || window.TonConnect || (window.TonConnectSDK && window.TonConnectSDK.TonConnect);
  const TonConnectUIGlobal = window.TonConnectUI || window.TON_CONNECT_UI || (window.TonConnectUI && window.TonConnectUI.TonConnectUI);

  if(!TonConnectSDKGlobal){
    setMsg('TonConnect SDK not available');
    log('TonConnect SDK missing — cannot open wallet chooser');
    // still keep connect button disabled so user uses fallback
  } else if(!TonConnectUIGlobal){
    setMsg('TonConnect UI not available — wallet chooser may not show nicely');
    log('TonConnect UI missing but SDK is present');
  } else {
    setMsg('TonConnect loaded — ready');
  }

  // create invoice helper
  const params = new URLSearchParams(location.search);
  const item = params.get('item') || 'boost_x2_1h';
  const user = params.get('user') || '';

  async function createInvoice(){
    try {
      const r = await fetch('/pay/create', {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ user_id: user, item })
      });
      const j = await r.json();
      log('createInvoice', j);
      return j;
    } catch(e){
      log('createInvoice error', e);
      return { success:false, message:'network error' };
    }
  }

  // if SDK present initialize TonConnect and UI
  let tonConnect, tonConnectUI, invoice;
  if(TonConnectSDKGlobal){
    const TonConnectCtor = TonConnectSDKGlobal.TonConnect || TonConnectSDKGlobal;
    try {
      tonConnect = new TonConnectCtor({ manifestUrl });
      if(TonConnectUIGlobal){
        const TonConnectUICtor = TonConnectUIGlobal.TonConnectUI || TonConnectUIGlobal;
        tonConnectUI = new TonConnectUICtor({ tonConnect });
      }
    } catch(e){
      log('TonConnect init error', e);
    }
  }

  // Prepare invoice now (so fallback URL includes comment)
  invoice = await createInvoice();
  if(!invoice.success){
    document.getElementById('title').innerText = 'Payment error';
    document.getElementById('desc').innerText = invoice.message || 'Failed to create invoice';
    setMsg('Invoice creation failed');
    return;
  }
  document.getElementById('price').innerText = `Price: ${invoice.amount} TON`;

  // connect & pay flow using TonConnect provider if available
  async function requestSendTransaction(provider){
    try {
      const to = invoice.address;
      const value = String(Math.round(Number(invoice.amount) * 1e9));
      const comment = invoice.comment;
      const tx = { to, value, text: comment };
      log('requestSendTransaction ->', tx);
      setMsg('Requesting transaction in wallet...');
      await provider.request({ method: 'ton_sendTransaction', params: [tx] });
      setMsg('Transaction requested — waiting for confirmation...');
      startPolling(comment);
    } catch(e){
      log('requestSendTransaction error', e);
      setMsg('Transaction request failed');
    }
  }

  async function connectAndPay(){
    if(!tonConnect){
      setMsg('TonConnect not initialized — use fallback');
      return;
    }
    setMsg('Connecting to wallet...');
    try { await tonConnect.connect(); log('connect result', tonConnect.connectedWallet); } catch(e){ log('connect rejected', e); }
    const provider = tonConnect.provider;
    if(provider){
      await requestSendTransaction(provider); return;
    }
    // open UI as fallback to let user choose wallet
    try {
      if(tonConnectUI && typeof tonConnectUI.open === 'function'){
        tonConnectUI.open();
        setMsg('Please select a wallet from chooser...');
      } else {
        setMsg('Wallet chooser not available');
      }
    } catch(e){ log('tonConnectUI.open failed', e); setMsg('Failed to open wallet chooser'); }

    // wait for provider
    let attempts = 0;
    while(attempts < 20 && !tonConnect.provider){
      await new Promise(r=>setTimeout(r, 500));
      attempts++;
      log('waiting for provider', attempts);
    }
    if(tonConnect.provider){
      await requestSendTransaction(tonConnect.provider);
    } else {
      setMsg('No wallet provider detected — use fallback button');
    }
  }

  // Polling like before
  let pollTimer = null;
  async function checkPaymentStatus(comment){
    try{ const r = await fetch(`/pay/status/${encodeURIComponent(comment)}`); return await r.json(); } catch(e){ return { success:false }; }
  }
  function startPolling(comment){
    if(pollTimer) return;
    pollTimer = setInterval(async ()=>{
      const s = await checkPaymentStatus(comment);
      log('poll', s);
      if(s && s.found && s.status === 'paid'){
        clearInterval(pollTimer); pollTimer=null;
        setMsg('Payment received — activating boost');
        try { await fetch('/pay/confirm', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ comment }) }); } catch(e){}
        setTimeout(()=>{ try{ if(window.Telegram && window.Telegram.WebApp) window.Telegram.WebApp.close(); else window.close(); } catch(e){ try{ window.close(); }catch(_){} } }, 1200);
      }
    }, 2500);
  }

  // wire buttons
  document.getElementById('connectBtn').addEventListener('click', async ()=>{
    document.getElementById('connectBtn').disabled = true;
    try { await connectAndPay(); } finally { document.getElementById('connectBtn').disabled = false; }
  });
  document.getElementById('openFallback').addEventListener('click', ()=>{
    const tonKeeperUrl = `https://app.tonkeeper.com/transfer/${encodeURIComponent(invoice.address)}?amount=${Math.round(Number(invoice.amount)*1e9)}&text=${encodeURIComponent(invoice.comment)}`;
    try { if(window.Telegram && window.Telegram.WebApp && typeof window.Telegram.WebApp.openLink === 'function') window.Telegram.WebApp.openLink(tonKeeperUrl); else window.open(tonKeeperUrl, '_blank'); } catch(e){ window.open(tonKeeperUrl, '_blank'); }
  });

})();
</script>
</body>
</html>
