<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>NJR ‚Äî Pay (TON Connect)</title>

  <!-- Use local CSS first (put your custom or official tonconnect-ui.min.css in public/) -->
  <link rel="stylesheet" href="/tonconnect-ui.min.css" id="tonconnect-ui-css"/>

  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#0f0b14;color:#fff;padding:18px}
    .card{max-width:520px;margin:36px auto;background:linear-gradient(180deg,#241731,#37243a);padding:18px;border-radius:12px;text-align:center}
    .btn{padding:12px 18px;border-radius:10px;background:#2d9cdb;color:#fff;font-weight:700;border:none;cursor:pointer}
    .btn.secondary{background:#6b46d6}
    .info{color:#cfc1e8;margin:10px 0}
    .log{margin-top:10px;color:#a9a0c6;font-size:13px;white-space:pre-wrap;text-align:left;max-height:220px;overflow:auto;padding:8px;background:rgba(255,255,255,0.02);border-radius:8px}
  </style>
</head>
<body>
  <div class="card">
    <h2 id="title">Buy Boost √ó2</h2>
    <div id="desc" class="info">Connecting wallet...</div>
    <div id="price" style="font-weight:800;font-size:20px;margin:8px 0"></div>

    <div style="display:flex;gap:8px;justify-content:center;margin-top:12px">
      <button id="connectBtn" class="btn">Connect Wallet</button>
      <button id="openFallback" class="btn secondary">Open Tonkeeper (fallback)</button>
    </div>

    <div id="msg" class="info"></div>
    <div id="log" class="log" aria-live="polite"></div>
  </div>

  <!-- Custom chooser modal (fallback UI that looks like TapSwap chooser) -->
  <div id="tcModalOverlay" class="tc-modal-overlay" style="display:none;align-items:center;justify-content:center;position:fixed;inset:0;z-index:9999;background:rgba(2,6,23,0.75);">
    <div class="tc-modal" style="width:92%;max-width:420px;background:#0f172a;border-radius:14px;padding:12px;color:#fff;">
      <div style="display:flex;justify-content:space-between;align-items:center;padding:10px;border-bottom:1px solid rgba(255,255,255,0.03);">
        <div style="font-weight:700;">Connect your wallet</div>
        <button id="tcCloseBtn" style="background:none;border:none;color:#cfc1e8;font-size:18px;cursor:pointer;">‚úï</button>
      </div>

      <div style="padding:12px;">
        <button id="tcOpenTelegram" style="display:flex;gap:10px;align-items:center;width:100%;padding:12px;border-radius:12px;background:#0ea5a2;color:#fff;border:none;font-weight:700;cursor:pointer;margin-bottom:12px;">
          <span style="font-size:18px;">‚úàÔ∏è</span>
          <div style="text-align:left;">
            <div>Open Wallet in Telegram</div>
            <div style="font-size:12px;color:#cfc1e8">Open Wallet in Telegram or select your wallet</div>
          </div>
        </button>

        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button class="tc-wallet-item" data-url="https://app.tonkeeper.com/transfer/" style="flex:1;min-width:120px;padding:10px;border-radius:12px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.03);color:#fff;cursor:pointer;">
            <div style="display:flex;gap:8px;align-items:center;"><span style="font-size:18px">üî∑</span><span>Tonkeeper</span></div>
          </button>

          <button class="tc-wallet-item" data-url="https://tonhub.com/transfer/" style="flex:1;min-width:120px;padding:10px;border-radius:12px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.03);color:#fff;cursor:pointer;">
            <div style="display:flex;gap:8px;align-items:center;"><span style="font-size:18px">üíé</span><span>Tonhub</span></div>
          </button>

          <button class="tc-wallet-item" data-url="https://mytonwallet.org/transfer/" style="flex:1;min-width:120px;padding:10px;border-radius:12px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.03);color:#fff;cursor:pointer;">
            <div style="display:flex;gap:8px;align-items:center;"><span style="font-size:18px">‚≠ï</span><span>MyTonWallet</span></div>
          </button>
        </div>

        <div style="font-size:12px;color:#9ca3af;margin-top:12px;text-align:center;">If TonConnect chooser is available it will open first; otherwise use wallet buttons above.</div>
      </div>
    </div>
  </div>

<script>
/* pay-tonconnect.html - robust TonConnect flow with fallback chooser */
(async function(){
  const logEl = document.getElementById('log');
  const msgEl = document.getElementById('msg');
  function log(...args){ console.log(...args); if(logEl) logEl.innerText += args.map(x=> typeof x === 'object' ? JSON.stringify(x) : String(x)).join(' ') + "\n"; }
  function setMsg(t){ if(msgEl) msgEl.innerText = t; }

  // dynamic script loader
  function loadScript(src){
    return new Promise((resolve,reject)=>{
      const s = document.createElement('script');
      s.src = src;
      s.async = true;
      s.onload = ()=>{ log('loaded', src); resolve(); };
      s.onerror = (e)=>{ log('failed to load', src); reject(new Error('Failed load '+src)); };
      document.head.appendChild(s);
    });
  }

  // Ensure CSS (local else CDN)
  try {
    const r = await fetch('/tonconnect-ui.min.css', { method:'HEAD' });
    if(!r.ok) throw new Error('missing local css');
    log('CSS local ok');
  } catch(e){
    log('CSS missing locally, using CDN', e.message);
    const link = document.getElementById('tonconnect-ui-css') || document.createElement('link');
    link.id = 'tonconnect-ui-css';
    link.rel = 'stylesheet';
    link.href = 'https://cdn.jsdelivr.net/npm/@tonconnect/ui@latest/dist/tonconnect-ui.min.css';
    document.head.appendChild(link);
  }

  // Load SDK/UI if necessary (try local first)
  if(!window.TonConnectSDK && !window.TonConnect){
    try { await loadScript('/tonconnect-sdk.min.js'); log('local sdk loaded'); } catch(e){
      log('local sdk failed, trying CDN', e.message);
      try { await loadScript('https://cdn.jsdelivr.net/npm/@tonconnect/sdk@latest/dist/tonconnect-sdk.min.js'); log('cdn sdk loaded'); } catch(e2){ log('cdn sdk failed', e2.message); }
    }
  } else {
    log('SDK already present on window');
  }

  if(!window.TonConnectUI && !window.TON_CONNECT_UI){
    try { await loadScript('/tonconnect-ui.min.js'); log('local ui loaded'); } catch(e){
      log('local ui failed, trying CDN', e.message);
      try { await loadScript('https://cdn.jsdelivr.net/npm/@tonconnect/ui@latest/dist/tonconnect-ui.min.js'); log('cdn ui loaded'); } catch(e2){ log('cdn ui failed', e2.message); }
    }
  } else {
    log('UI already present on window');
  }

  log('window keys', { TonConnectSDK: !!window.TonConnectSDK, TonConnect: !!window.TonConnect, TonConnectUI: !!window.TonConnectUI, TON_CONNECT_UI: !!window.TON_CONNECT_UI });

  // Detect constructors/globals
  const TonSDKGlobal = window.TonConnectSDK || window.TonConnect || null;
  const TonUIGlobal = window.TonConnectUI || window.TON_CONNECT_UI || null;

  // Create TonConnect instance
  const manifestUrl = `${location.origin}/tonconnect-manifest.json`;
  let tonConnect = null;
  try {
    if(TonSDKGlobal){
      const TonCtor = (TonSDKGlobal.TonConnect && TonSDKGlobal.TonConnect) || TonSDKGlobal;
      tonConnect = new TonCtor({ manifestUrl });
      window.tonConnect = tonConnect;
      log('tonConnect created');
    } else {
      log('TonConnect SDK not available - will rely on fallback links');
    }
  } catch(e){
    log('TonConnect init error', e && e.message ? e.message : e);
    setMsg('TonConnect init failed ‚Äî using fallback');
  }

  // Create TonConnect UI instance if available
  let tonConnectUI = null;
  try {
    if(TonUIGlobal && tonConnect){
      const UIctor = (TonUIGlobal.TonConnectUI && TonUIGlobal.TonConnectUI) || TonUIGlobal;
      tonConnectUI = new UIctor({ tonConnect });
      window.tonConnectUI = tonConnectUI;
      log('tonConnectUI created');
    } else {
      log('TonConnectUI not created (missing constructor or tonConnect)');
    }
  } catch(e){
    log('TonConnectUI init error', e && e.message ? e.message : e);
  }

  // invoice creation
  const params = new URLSearchParams(location.search);
  const item = params.get('item') || 'boost_x2_1h';
  const user = params.get('user') || '';

  async function createInvoice(){
    try {
      const r = await fetch('/pay/create', {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ user_id: user, item })
      });
      const j = await r.json();
      log('createInvoice', j);
      return j;
    } catch(e){
      log('createInvoice error', e);
      return { success:false, message:'network error' };
    }
  }

  const invoice = await createInvoice();
  if(!invoice.success){
    document.getElementById('title').innerText = 'Payment error';
    document.getElementById('desc').innerText = invoice.message || 'Failed to create invoice';
    setMsg('Invoice creation failed');
    return;
  }
  // expose globally for chooser fallback
  window.invoice = invoice;
  document.getElementById('price').innerText = `Price: ${invoice.amount} TON`;

  // helper: request transaction
  async function requestSendTransaction(provider){
    try {
      const to = invoice.address;
      const value = String(Math.round(Number(invoice.amount) * 1e9));
      const comment = invoice.comment;
      const tx = { to, value, text: comment };
      log('requestSendTransaction ->', tx);
      setMsg('Requesting transaction in wallet...');
      await provider.request({ method: 'ton_sendTransaction', params: [tx] });
      setMsg('Transaction requested ‚Äî waiting for confirmation...');
      startPolling(comment);
    } catch(e){
      log('requestSendTransaction error', e);
      setMsg('Transaction request failed');
    }
  }

  // Polling
  let pollTimer = null;
  async function checkPaymentStatus(comment){
    try {
      const r = await fetch(`/pay/status/${encodeURIComponent(comment)}`);
      return await r.json();
    } catch(e){ return { success:false }; }
  }
  function startPolling(comment){
    if(pollTimer) return;
    pollTimer = setInterval(async ()=>{
      const s = await checkPaymentStatus(comment);
      log('poll', s);
      if(s && s.found && s.status === 'paid'){
        clearInterval(pollTimer); pollTimer = null;
        setMsg('Payment received ‚Äî activating boost');
        try { await fetch('/pay/confirm', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ comment }) }); } catch(e){}
        setTimeout(()=>{ try{ if(window.Telegram && window.Telegram.WebApp) window.Telegram.WebApp.close(); else window.close(); } catch(e){} }, 1200);
      }
    }, 2500);
  }

  // Fallback chooser function (opens modal with wallet links)
  window.openTonChooser = function(invoiceObj){
    const overlay = document.getElementById('tcModalOverlay');
    const closeBtn = document.getElementById('tcCloseBtn');
    const openTelegramBtn = document.getElementById('tcOpenTelegram');
    const walletBtns = document.querySelectorAll('.tc-wallet-item[data-url]');

    function hide(){ overlay.style.display='none'; }
    function show(){ overlay.style.display='flex'; }

    // attach wallet links
    walletBtns.forEach(btn=>{
      btn.onclick = ()=>{
        const base = btn.getAttribute('data-url');
        const addr = invoiceObj && invoiceObj.address ? invoiceObj.address : '';
        const amount = invoiceObj && invoiceObj.amount ? Math.round(Number(invoiceObj.amount) * 1e9) : '';
        const comment = invoiceObj && invoiceObj.comment ? encodeURIComponent(invoiceObj.comment) : '';
        const url = base + (addr ? encodeURIComponent(addr) : '') + (amount ? `?amount=${amount}&text=${comment}` : '');
        try {
          if(window.Telegram && window.Telegram.WebApp && typeof window.Telegram.WebApp.openLink === 'function'){
            window.Telegram.WebApp.openLink(url);
          } else {
            window.open(url, '_blank');
          }
        } catch(e){
          window.open(url, '_blank');
        }
        hide();
      };
    });

    openTelegramBtn.onclick = ()=>{
      const addr = invoiceObj && invoiceObj.address ? invoiceObj.address : '';
      const amount = invoiceObj && invoiceObj.amount ? Math.round(Number(invoiceObj.amount) * 1e9) : '';
      const comment = invoiceObj && invoiceObj.comment ? encodeURIComponent(invoiceObj.comment) : '';
      const url = `https://app.tonkeeper.com/transfer/${encodeURIComponent(addr)}?amount=${amount}&text=${comment}`;
      try {
        if(window.Telegram && window.Telegram.WebApp && typeof window.Telegram.WebApp.openLink === 'function'){
          window.Telegram.WebApp.openLink(url);
        } else {
          window.open(url, '_blank');
        }
      } catch(e){
        window.open(url, '_blank');
      }
      hide();
    };

    closeBtn.onclick = hide;
    overlay.onclick = (ev) => { if(ev.target === overlay) hide(); };

    show();
  };

  // Connect button logic: try TonConnectUI.open(), wait provider, fallback to custom chooser
  document.getElementById('connectBtn').addEventListener('click', async ()=>{
    const btn = document.getElementById('connectBtn');
    btn.disabled = true;
    setMsg('Attempting to open wallet chooser...');
    try {
      // Try open TonConnectUI if available
      if(window.tonConnectUI && typeof window.tonConnectUI.open === 'function'){
        try { window.tonConnectUI.open(); log('called tonConnectUI.open()'); } catch(e){ log('tonConnectUI.open() error', e); }
      } else {
        // try to build temporary UI if SDK & UI constructors exist
        try {
          const Ton = (window.TonConnectSDK && window.TonConnectSDK.TonConnect) || window.TonConnect;
          const UI = (window.TonConnectUI && window.TonConnectUI.TonConnectUI) || window.TON_CONNECT_UI && window.TON_CONNECT_UI.TonConnectUI;
          if(Ton && UI){
            window.tonConnect = new Ton({ manifestUrl });
            window.tonConnectUI = new UI({ tonConnect: window.tonConnect });
            try { window.tonConnectUI.open(); log('opened temporary tonConnectUI'); } catch(e){ log('tempUI.open err', e); }
          }
        } catch(e){ log('temp UI creation failed', e); }
      }

      // Wait for provider to appear (user may select wallet)
      const waitForProvider = async (timeoutMs=6000) => {
        const step = 300;
        let waited = 0;
        while(waited < timeoutMs){
          if((window.tonConnect && window.tonConnect.provider) || (window.TonConnect && window.TonConnect.provider)) return true;
          await new Promise(r=>setTimeout(r, step));
          waited += step;
        }
        return false;
      };

      const providerDetected = await waitForProvider(6000);
      if(providerDetected){
        setMsg('Wallet connected ‚Äî requesting transaction...');
        const provider = (window.tonConnect && window.tonConnect.provider) || (window.TonConnect && window.TonConnect.provider) || null;
        if(provider){
          await requestSendTransaction(provider);
        } else {
          setMsg('Connected but no provider object found - use fallback');
          log('provider object missing despite detection');
        }
      } else {
        setMsg('No wallet provider detected ‚Äî showing wallet chooser (fallback)');
        if(typeof window.openTonChooser === 'function'){
          window.openTonChooser(window.invoice);
        } else {
          setMsg('Fallback chooser not available - use Tonkeeper button');
        }
      }

    } catch(err){
      console.error('connectBtn error', err);
      setMsg('Connection failed, use fallback');
    } finally {
      btn.disabled = false;
    }
  });

  // fallback external link (Tonkeeper)
  document.getElementById('openFallback').addEventListener('click', ()=>{
    const tonKeeperUrl = `https://app.tonkeeper.com/transfer/${encodeURIComponent(invoice.address)}?amount=${Math.round(Number(invoice.amount)*1e9)}&text=${encodeURIComponent(invoice.comment)}`;
    try { if(window.Telegram && window.Telegram.WebApp && typeof window.Telegram.WebApp.openLink === 'function') window.Telegram.WebApp.openLink(tonKeeperUrl); else window.open(tonKeeperUrl, '_blank'); } catch(e){ window.open(tonKeeperUrl, '_blank'); }
  });

  setMsg('Ready ‚Äî click Connect Wallet');

})();
</script>

</body>
</html>
