<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Pay — NJR (TON Connect)</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#0f0b14;color:#fff;padding:20px}
    .card{background:linear-gradient(180deg,#241731,#37243a);border-radius:12px;padding:18px;max-width:420px;margin:30px auto;text-align:center}
    .btn{display:inline-block;padding:12px 18px;border-radius:10px;background:#6b46d6;color:#fff;font-weight:700;border:none;cursor:pointer}
    .btn.ton{background:#2d9cdb}
    .info{margin:14px 0;color:#cfc1e8}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:24px;background:#111;padding:10px 14px;border-radius:8px;color:#fff;display:none}
  </style>
</head>
<body>
  <div class="card">
    <h2 id="title">Preparing payment...</h2>
    <div class="info" id="desc">Please wait</div>
    <div id="price" style="font-weight:800;font-size:20px;margin:12px 0"></div>

    <button id="connectBtn" class="btn ton">Connect Wallet</button>
    <div style="height:8px"></div>
    <button id="cancelBtn" class="btn" style="margin-top:10px;background:#444;color:#fff">Cancel</button>

    <div style="height:10px"></div>
    <div id="msg" style="color:#a9a0c6;margin-top:12px;font-size:13px"></div>
  </div>

  <div id="toast" class="toast"></div>

  <!-- TonConnect UMD bundle (from unpkg) -->
  <script src="https://unpkg.com/@tonconnect/sdk/dist/tonconnect.umd.js"></script>
  <script>
  (async function(){
    const toast = (t, ms=1800) => {
      const el = document.getElementById('toast');
      el.innerText = t; el.style.display = 'block';
      clearTimeout(el._to);
      el._to = setTimeout(()=> el.style.display='none', ms);
    };

    const params = new URLSearchParams(location.search);
    const item = params.get('item') || 'boost_x2_1h';
    const user = params.get('user') || '';

    // create invoice on server
    async function createInvoice(){
      try{
        const res = await fetch('/pay/create', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ user_id: user, item })
        });
        return await res.json();
      } catch(e){
        return { success:false, message: 'Network error' };
      }
    }

    const res = await createInvoice();
    const titleEl = document.getElementById('title');
    const descEl = document.getElementById('desc');
    const priceEl = document.getElementById('price');
    const msgEl = document.getElementById('msg');
    const connectBtn = document.getElementById('connectBtn');
    const cancelBtn = document.getElementById('cancelBtn');

    if(!res.success){
      titleEl.innerText = 'Payment error';
      descEl.innerText = res.message || 'Failed to create payment';
      msgEl.innerText = 'Please try again later';
      connectBtn.disabled = true;
      return;
    }

    const address = res.address;
    const amount = Number(res.amount);
    const comment = res.comment;

    titleEl.innerText = 'Buy Boost ×2';
    descEl.innerText = 'Connect a TON wallet to pay';
    priceEl.innerText = `Price: ${amount} TON`;

    // Initialize TonConnect with manifest hosted on same origin
    const manifestUrl = `${location.origin}/tonconnect-manifest.json`;
    const tonConnect = new window.TonConnect.TonConnect({ manifestUrl });

    // function to start the connection modal
    async function openTonConnect() {
      try {
        // show modal and let user select wallet
        await tonConnect.connect(); // opens TonConnect modal

        // after connect, provider available
        const provider = tonConnect.provider;
        if(!provider){
          toast('No provider available');
          return;
        }

        // Build transfer payload for ton_sendTransaction (value in nanotons as string)
        const valueNano = String(Math.round(amount * 1e9));
        const tx = {
          to: address,
          value: valueNano,
          // Some wallets support 'text' or 'payload' - we include text as comment
          // Some implementors expect 'data' or 'payload'; text works with TonKeeper
          text: comment
        };

        // Request transaction via provider (TonConnect uses JSON-RPC style method)
        // Method 'ton_sendTransaction' is commonly supported
        await provider.request({
          method: 'ton_sendTransaction',
          params: [tx]
        });

        // start polling server for payment confirmation (server /pay/status)
        startPollingPayment(comment);

        toast('Transaction sent. Please confirm in your wallet', 2500);

      } catch (err) {
        console.error('TonConnect error', err);
        toast('Wallet connect failed');
      }
    }

    connectBtn.addEventListener('click', openTonConnect);
    cancelBtn.addEventListener('click', ()=> {
      try { if(window.Telegram && window.Telegram.WebApp) window.Telegram.WebApp.close(); else history.back(); } catch(e){ history.back(); }
    });

    // polling to check payment status (server endpoint)
    let pollTimer = null;
    async function checkPaymentStatus(comment){
      try{
        const r = await fetch(`/pay/status/${encodeURIComponent(comment)}`);
        const j = await r.json();
        return j;
      }catch(e){ return { found:false }; }
    }

    function startPollingPayment(comment){
      if(pollTimer) return;
      pollTimer = setInterval(async ()=>{
        const s = await checkPaymentStatus(comment);
        if(s && s.found && s.status === 'paid'){
          clearInterval(pollTimer);
          pollTimer = null;
          toast('Payment received — activating boost', 2000);
          // call /pay/confirm to ensure server activates the boost
          try { await fetch('/pay/confirm', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ comment }) }); } catch(e){}
          setTimeout(()=>{ try{ if(window.Telegram && window.Telegram.WebApp) window.Telegram.WebApp.close(); else window.close(); } catch(e){ window.close(); } }, 1200);
        }
      }, 2500);
    }

  })();
  </script>
</body>
</html>
