<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>NJR — Pay (TON Connect)</title>
  <link rel="stylesheet" href="https://unpkg.com/@tonconnect/ui/dist/tonconnect-ui.min.css"/>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#0f0b14;color:#fff;padding:18px}
    .card{max-width:520px;margin:36px auto;background:linear-gradient(180deg,#241731,#37243a);padding:18px;border-radius:12px;text-align:center}
    .btn{padding:12px 18px;border-radius:10px;background:#2d9cdb;color:#fff;font-weight:700;border:none;cursor:pointer}
    .btn.secondary{background:#6b46d6}
    .info{color:#cfc1e8;margin:10px 0}
    .log{margin-top:10px;color:#a9a0c6;font-size:13px;white-space:pre-wrap;text-align:left;max-height:160px;overflow:auto;padding:8px;background:rgba(255,255,255,0.02);border-radius:8px}
  </style>
</head>
<body>
  <div class="card">
    <h2 id="title">Buy Boost ×2</h2>
    <div id="desc" class="info">Connect a TON wallet to pay</div>
    <div id="price" style="font-weight:800;font-size:20px;margin:8px 0"></div>

    <div style="display:flex;gap:8px;justify-content:center;margin-top:12px">
      <button id="connectBtn" class="btn">Connect Wallet</button>
      <button id="openFallback" class="btn secondary">Open Tonkeeper (fallback)</button>
    </div>

    <div id="msg" class="info"></div>
    <div id="log" class="log" aria-live="polite"></div>
  </div>

  <!-- TonConnect SDK + UI UMD bundles -->
  <script src="https://unpkg.com/@tonconnect/sdk/dist/tonconnect.umd.js"></script>
  <script src="https://unpkg.com/@tonconnect/ui/dist/tonconnect-ui.min.js"></script>

  <!-- استبدل سكربت pay-tonconnect.html بالآتي -->
<script>
(async function(){
  const logEl = document.getElementById('log');
  const msgEl = document.getElementById('msg');
  function log(...args){ console.log(...args); logEl.innerText += args.map(x=>typeof x==='object'?JSON.stringify(x):String(x)).join(' ') + "\n"; }
  function setMsg(t){ msgEl.innerText = t; }

  const params = new URLSearchParams(location.search);
  const item = params.get('item') || 'boost_x2_1h';
  const user = params.get('user') || '';

  async function createInvoice(){
    try{
      const res = await fetch('/pay/create', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ user_id: user, item })
      });
      return await res.json();
    }catch(e){
      return { success:false, message:'network error', error: String(e) };
    }
  }

  const invoice = await createInvoice();
  if(!invoice.success){
    document.getElementById('title').innerText = 'Payment error';
    document.getElementById('desc').innerText = invoice.message || 'Failed to create invoice';
    log('createInvoice failed', invoice);
    setMsg('Invoice creation failed');
    return;
  }

  document.getElementById('price').innerText = `Price: ${invoice.amount} TON`;
  log('invoice created', invoice);

  const manifestUrl = `${location.origin}/tonconnect-manifest.json`;
  log('manifestUrl', manifestUrl);

  if (!window.TonConnect || !window.TonConnectUI) {
    log('TonConnect SDK not loaded', {TonConnect: !!window.TonConnect, TonConnectUI: !!window.TonConnectUI});
    setMsg('TonConnect SDK not available');
    return;
  }

  const tonConnect = new window.TonConnect.TonConnect({ manifestUrl });
  const tonConnectUI = new window.TonConnectUI.TonConnectUI({ tonConnect });

  // helper: try to open UI/connection using several strategies
  async function openWalletFlow(){
    setMsg('Opening wallet chooser...');
    log('openWalletFlow: trying tonConnectUI.open()');
    try {
      // try opening TonConnect UI (displays modal list)
      tonConnectUI.open();
      log('tonConnectUI.open() called');
      return true;
    } catch(e){
      log('tonConnectUI.open() failed', e);
    }

    // fallback: try direct connect (some wallets respond to this)
    try {
      log('Trying tonConnect.connect() fallback');
      await tonConnect.connect();
      log('tonConnect.connect() resolved', { connectedWallet: tonConnect.connectedWallet });
      return true;
    } catch(e){
      log('tonConnect.connect() failed', e);
    }

    // final fallback: open tonkeeper web page in new tab
    try {
      const tonKeeperUrl = `https://app.tonkeeper.com/transfer/${encodeURIComponent(invoice.address)}?amount=${Math.round(Number(invoice.amount)*1e9)}&text=${encodeURIComponent(invoice.comment)}`;
      log('Opening fallback URL', tonKeeperUrl);
      // prefer Telegram.WebApp.openLink to open externally within the Telegram client
      if (window.Telegram && window.Telegram.WebApp && typeof window.Telegram.WebApp.openLink === 'function') {
        window.Telegram.WebApp.openLink(tonKeeperUrl);
      } else {
        window.open(tonKeeperUrl, '_blank');
      }
      return true;
    } catch(e){
      log('fallback open failed', e);
      return false;
    }
  }

  async function requestSendTransaction(provider){
    try {
      const to = invoice.address;
      const value = String(Math.round(Number(invoice.amount) * 1e9));
      const comment = invoice.comment;
      const tx = { to, value, text: comment };
      log('requestSendTransaction ->', tx);
      setMsg('Requesting transaction in wallet...');
      await provider.request({ method: 'ton_sendTransaction', params: [tx] });
      log('provider.request returned (tx requested)');
      setMsg('Transaction requested — waiting for confirmation...');
      startPolling(comment);
    } catch (e){
      log('requestSendTransaction error', e);
      setMsg('Transaction request failed');
    }
  }

  // attempt to connect & then request tx if provider available
  async function connectAndPay(){
    setMsg('Connecting to wallet...');
    try {
      // Try connect (this may open modal if allowed)
      await tonConnect.connect();
      log('tonConnect.connect() resolved', { connectedWallet: tonConnect.connectedWallet });
    } catch (e) {
      log('tonConnect.connect() rejected/failed', e);
    }

    const provider = tonConnect.provider;
    log('after connect provider', !!provider, 'connectedWallet', tonConnect.connectedWallet);
    if (provider) {
      await requestSendTransaction(provider);
    } else {
      log('provider not available after connect — trying open UI then waiting for user to select wallet');
      // open UI and wait; in many flows the UI opens and user selects wallet which sets tonConnect.provider
      try { tonConnectUI.open(); } catch(e){ log('tonConnectUI.open() error', e); }
      // poll for provider availability for short time
      let attempts = 0;
      const maxAttempts = 20;
      const wait = ms => new Promise(res => setTimeout(res, ms));
      while(attempts < maxAttempts && !tonConnect.provider){
        await wait(500);
        attempts++;
        log('waiting for provider...', attempts);
      }
      if (tonConnect.provider){
        log('provider detected after UI open');
        await requestSendTransaction(tonConnect.provider);
      } else {
        log('provider still not available');
        setMsg('Could not detect wallet provider. Try the fallback button.');
      }
    }
  }

  // attach to button
  const connectBtn = document.getElementById('connectBtn');
  connectBtn.addEventListener('click', async ()=>{
    connectBtn.disabled = true;
    try {
      // First try UI open (fast)
      const ok = await openWalletFlow();
      if (!ok) setMsg('Failed to open wallet chooser');
      // after we opened the UI try connect+pay (some wallets require explicit connect)
      await connectAndPay();
    } finally {
      connectBtn.disabled = false;
    }
  });

  // fallback button behaviour
  document.getElementById('openFallback').addEventListener('click', ()=>{
    const tonKeeperUrl = `https://app.tonkeeper.com/transfer/${encodeURIComponent(invoice.address)}?amount=${Math.round(Number(invoice.amount)*1e9)}&text=${encodeURIComponent(invoice.comment)}`;
    if (window.Telegram && window.Telegram.WebApp && typeof window.Telegram.WebApp.openLink === 'function') {
      window.Telegram.WebApp.openLink(tonKeeperUrl);
    } else {
      window.open(tonKeeperUrl, '_blank');
    }
  });

  // autoOpen if param set (called after a short delay)
  const autoOpen = params.get('autoOpen') === '1' || params.get('autoOpen') === 'true';
  if (autoOpen) {
    setTimeout(async ()=>{
      log('autoOpen: attempting openWalletFlow and connectAndPay');
      try {
        await openWalletFlow();
        await connectAndPay();
      } catch(e){
        log('autoOpen full flow failed', e);
      }
    }, 250);
  }

  log('page ready — click Connect Wallet (or fallback)'); 
})();
</script>
</body>
</html>
