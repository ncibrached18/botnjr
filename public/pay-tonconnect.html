<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>NJR — Pay (TON Connect)</title>

  <!-- CSS محلي أولاً -->
  <link rel="stylesheet" href="/tonconnect-ui.min.css" id="tonconnect-ui-css"/>

  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#0f0b14;color:#fff;padding:18px}
    .card{max-width:520px;margin:36px auto;background:linear-gradient(180deg,#241731,#37243a);padding:18px;border-radius:12px;text-align:center}
    .btn{padding:12px 18px;border-radius:10px;background:#2d9cdb;color:#fff;font-weight:700;border:none;cursor:pointer}
    .btn.secondary{background:#6b46d6}
    .info{color:#cfc1e8;margin:10px 0}
    .log{margin-top:10px;color:#a9a0c6;font-size:13px;white-space:pre-wrap;text-align:left;max-height:200px;overflow:auto;padding:8px;background:rgba(255,255,255,0.02);border-radius:8px}
  </style>
</head>
<body>
  <div class="card">
    <h2 id="title">Buy Boost ×2</h2>
    <div id="desc" class="info">Connecting wallet...</div>
    <div id="price" style="font-weight:800;font-size:20px;margin:8px 0"></div>

    <div style="display:flex;gap:8px;justify-content:center;margin-top:12px">
      <button id="connectBtn" class="btn">Connect Wallet</button>
      <button id="openFallback" class="btn secondary">Open Tonkeeper (fallback)</button>
    </div>

    <div id="msg" class="info"></div>
    <div id="log" class="log" aria-live="polite"></div>
  </div>

<script>
(async function(){
  const logEl = document.getElementById('log');
  const msgEl = document.getElementById('msg');
  function log(...args){ console.log(...args); if(logEl) logEl.innerText += args.map(x=> typeof x === 'object' ? JSON.stringify(x) : String(x)).join(' ') + "\n"; }
  function setMsg(t){ if(msgEl) msgEl.innerText = t; }

  // loader script helper
  function loadScript(src){
    return new Promise((resolve,reject)=>{
      const s = document.createElement('script');
      s.src = src;
      s.async = true;
      s.onload = ()=>{ log('loaded', src); resolve(); };
      s.onerror = (e)=>{ log('failed to load', src); reject(new Error('Failed load '+src)); };
      document.head.appendChild(s);
    });
  }

  // Ensure CSS - try local then CDN
  try {
    const r = await fetch('/tonconnect-ui.min.css', { method:'HEAD' });
    if(!r.ok) throw new Error('missing local css');
    log('CSS local ok');
  } catch(e){
    log('CSS missing locally, using CDN', e.message);
    const link = document.getElementById('tonconnect-ui-css') || document.createElement('link');
    link.id = 'tonconnect-ui-css';
    link.rel = 'stylesheet';
    link.href = 'https://cdn.jsdelivr.net/npm/@tonconnect/ui@latest/dist/tonconnect-ui.min.css';
    document.head.appendChild(link);
  }

  // Load SDK & UI JS if not already present
  if(!window.TonConnectSDK && !window.TonConnect){
    try { await loadScript('/tonconnect-sdk.min.js'); log('local sdk loaded'); } catch(e){
      log('local sdk failed, trying CDN', e.message);
      try { await loadScript('https://cdn.jsdelivr.net/npm/@tonconnect/sdk@latest/dist/tonconnect-sdk.min.js'); log('cdn sdk loaded'); } catch(e2){ log('cdn sdk failed', e2.message); }
    }
  }
  if(!window.TonConnectUI && !window.TON_CONNECT_UI){
    try { await loadScript('/tonconnect-ui.min.js'); log('local ui loaded'); } catch(e){
      log('local ui failed, trying CDN', e.message);
      try { await loadScript('https://cdn.jsdelivr.net/npm/@tonconnect/ui@latest/dist/tonconnect-ui.min.js'); log('cdn ui loaded'); } catch(e2){ log('cdn ui failed', e2.message); }
    }
  }

  log('window keys', { TonConnectSDK: !!window.TonConnectSDK, TonConnect: !!window.TonConnect, TonConnectUI: !!window.TonConnectUI, TON_CONNECT_UI: !!window.TON_CONNECT_UI });

  // Determine SDK/UI globals
  const TonConnectSDKGlobal = window.TonConnectSDK || window.TonConnect || null;
  const TonConnectUIGlobal = window.TonConnectUI || window.TON_CONNECT_UI || null;

  if(!TonConnectSDKGlobal){
    setMsg('TonConnect SDK missing; only fallback available');
    log('SDK missing; cannot continue');
    // still allow fallback button to open Tonkeeper deeplink
  }

  // create TonConnect
  let tonConnect = null;
  const manifestUrl = `${location.origin}/tonconnect-manifest.json`;
  if(TonConnectSDKGlobal){
    try {
      const TonCtor = TonConnectSDKGlobal.TonConnect || TonConnectSDKGlobal;
      tonConnect = new TonCtor({ manifestUrl });
      log('tonConnect created');
    } catch(e){
      log('TonConnect init error', e && e.message ? e.message : e);
      setMsg('TonConnect init failed — check console');
      // continue to allow fallback
    }
  }

  // create UI
  let tonConnectUI = null;
  if(TonConnectUIGlobal && tonConnect){
    try {
      const UIctor = TonConnectUIGlobal.TonConnectUI || TonConnectUIGlobal;
      tonConnectUI = new UIctor({ tonConnect });
      log('tonConnectUI created');
    } catch(e){ log('TonConnectUI init error', e); }
  } else if(!TonConnectUIGlobal){
    log('TonConnectUI not available; chooser UI will not show');
  }

  // invoice creation
  const params = new URLSearchParams(location.search);
  const item = params.get('item') || 'boost_x2_1h';
  const user = params.get('user') || '';

  async function createInvoice(){
    try {
      const r = await fetch('/pay/create', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ user_id:user, item })});
      const j = await r.json();
      log('createInvoice', j);
      return j;
    } catch(e){ log('createInvoice error', e); return { success:false, message:'network' }; }
  }

  const invoice = await createInvoice();
  if(!invoice.success){ setMsg('Invoice creation failed'); return; }
  document.getElementById('price').innerText = `Price: ${invoice.amount} TON`;

  // send tx via provider
  async function requestSendTransaction(provider){
    try {
      const to = invoice.address;
      const value = String(Math.round(Number(invoice.amount) * 1e9));
      const comment = invoice.comment;
      const tx = { to, value, text: comment };
      log('requestSendTransaction ->', tx);
      setMsg('Requesting transaction in wallet...');
      await provider.request({ method:'ton_sendTransaction', params: [tx] });
      setMsg('Transaction requested — waiting for confirmation...');
      startPolling(comment);
    } catch(e){
      log('requestSendTransaction error', e);
      setMsg('Transaction request failed');
    }
  }

  // connect and pay: open chooser then wait provider
  async function connectAndPay(){
    setMsg('Opening wallet chooser...');
    if(tonConnectUI && typeof tonConnectUI.open === 'function'){
      try { tonConnectUI.open(); } catch(e){ log('tonConnectUI.open error', e); }
    } else {
      try { await tonConnect.connect(); } catch(e){ log('tonConnect.connect rejected', e); }
    }

    // wait provider
    let attempts = 0;
    const maxAttempts = 30;
    while(attempts < maxAttempts && !(tonConnect && tonConnect.provider)){
      await new Promise(r=>setTimeout(r, 500));
      attempts++;
      log('waiting for provider', attempts);
    }
    if(tonConnect && tonConnect.provider){
      log('provider detected', tonConnect.provider);
      await requestSendTransaction(tonConnect.provider);
    } else {
      setMsg('No wallet provider detected — use fallback button');
      log('provider not detected');
    }
  }

  // poll payment endpoint
  let pollTimer = null;
  async function checkPaymentStatus(comment){ try{ const r = await fetch(`/pay/status/${encodeURIComponent(comment)}`); return await r.json(); }catch(e){ return { success:false }; } }
  function startPolling(comment){
    if(pollTimer) return;
    pollTimer = setInterval(async ()=>{
      const s = await checkPaymentStatus(comment);
      log('poll', s);
      if(s && s.found && s.status === 'paid'){
        clearInterval(pollTimer); pollTimer = null;
        setMsg('Payment received — activating boost');
        try { await fetch('/pay/confirm', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ comment }) }); } catch(e){}
        setTimeout(()=>{ try{ if(window.Telegram && window.Telegram.WebApp) window.Telegram.WebApp.close(); else window.close(); } catch(e){} }, 1200);
      }
    }, 2500);
  }

  // wire buttons
  document.getElementById('connectBtn').addEventListener('click', async ()=>{ document.getElementById('connectBtn').disabled = true; try{ await connectAndPay(); } finally{ document.getElementById('connectBtn').disabled = false; } });
  document.getElementById('openFallback').addEventListener('click', ()=> {
    const tonKeeperUrl = `https://app.tonkeeper.com/transfer/${encodeURIComponent(invoice.address)}?amount=${Math.round(Number(invoice.amount)*1e9)}&text=${encodeURIComponent(invoice.comment)}`;
    try { if(window.Telegram && window.Telegram.WebApp && typeof window.Telegram.WebApp.openLink === 'function') window.Telegram.WebApp.openLink(tonKeeperUrl); else window.open(tonKeeperUrl, '_blank'); } catch(e){ window.open(tonKeeperUrl, '_blank'); }
  });

  setMsg('Ready — click Connect Wallet');
})();
</script>
</body>
</html>
