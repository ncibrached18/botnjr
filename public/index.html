<!doctype html>
<html lang="ar">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>NJR</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

<style>
/* ÿπÿßŸÖ */
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color: transparent;}
html,body{width:100%;height:100%;overflow:hidden;font-family:'Poppins',system-ui;background: radial-gradient(circle at 20% 10%, #3a2b4b 0%, #181226 45%, #100b16 100%);color:#fff;direction:rtl}
.container{width:100%;height:100%;display:flex;flex-direction:column}

/* ===== ÿ±ÿ£ÿ≥ ÿßŸÑÿµŸÅÿ≠ÿ© ===== */
.header{
  padding:18px 18px 8px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
}
.header-left{
  display:flex;
  flex-direction:column;
  gap:10px;
  flex:1;
}
.title-row{
  display:flex;
  align-items:center;
  gap:12px;
}
.app-title{
  background:linear-gradient(90deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
  padding:10px 18px;
  border-radius:12px;
  font-weight:700;
  color:#efe9ff;
  display:inline-flex;
  align-items:center;
  gap:10px;
  box-shadow:inset 0 -2px 0 rgba(0,0,0,0.2);
}
.points-pill{
  display:inline-flex;
  align-items:center;
  gap:8px;
  background:linear-gradient(90deg,#402e56,#51386a);
  padding:8px 12px;
  border-radius:12px;
  font-weight:700;
  color:#ffdd7a;
  box-shadow:0 6px 18px rgba(0,0,0,0.45);
}

/* small top buttons */
.top-buttons{
  display:flex;
  gap:10px;
  margin-top:6px;
}
.top-btn{
  padding:10px 14px;
  border-radius:12px;
  background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  color:#ddd;
  display:inline-flex;
  align-items:center;
  gap:8px;
  font-weight:600;
  border:1px solid rgba(255,255,255,0.03);
}

/* ===== ÿßŸÑŸàÿ≥ÿ∑ ŸÖÿπ ÿßŸÑÿπŸÖŸÑÿ© ===== */
.main{
  flex:1;
  display:flex;
  align-items:center;
  justify-content:center;
  position:relative;
  padding:8px 18px 20px;
}

/* large coin wrapper */
.coin-wrap{
  position:relative;
  width:360px;
  height:360px;
  display:flex;
  align-items:center;
  justify-content:center;
  pointer-events:none; /* allow clicks to pass to .coin which will be placed on top */
}
.coin{
  position:absolute;
  width:320px;
  height:320px;
  border-radius:50%;
  overflow:visible;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  transform:translateY(10px);
  z-index:5;
  pointer-events:auto;
}
.coin img{width:100%;height:100%;object-fit:contain;user-select:none;pointer-events:none;}

/* energy + boost row under the coin */
.status-row{
  position:absolute;
  left:28px;
  bottom:120px;
  display:flex;
  align-items:center;
  gap:16px;
  z-index:4;
}
.energy-box{
  background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  padding:10px 14px;
  border-radius:10px;
  font-weight:700;
  color:#fff;
  display:flex;
  align-items:center;
  gap:10px;
  border:1px solid rgba(255,255,255,0.04);
}
.boost-btn{
  margin-left:8px;
  background:linear-gradient(90deg,#3a2541,#4a2f5a);
  color:#ffdf9a;
  padding:10px 12px;
  border-radius:10px;
  font-weight:700;
  border:1px solid rgba(255,255,255,0.03);
  display:flex;
  align-items:center;
  gap:8px;
}

/* subtle decorative rounded bar behind bottom nav */
.bottom-decor{
  position:fixed;
  left:12px;
  right:12px;
  bottom:12px;
  height:86px;
  border-radius:18px;
  background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  box-shadow:0 8px 30px rgba(0,0,0,0.6);
  display:flex;
  align-items:end;
  justify-content:center;
  padding-bottom:10px;
  z-index:3;
  border:1px solid rgba(255,255,255,0.02);
}

/* bottom nav */
.bottom{
  width:96%;
  max-width:760px;
  display:flex;
  gap:12px;
  justify-content:space-between;
  align-items:center;
}
.nav{
  width:20%;
  min-width:64px;
  background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.01));
  border-radius:12px;
  padding:10px 6px;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:6px;
  color:#cfc1e8;
  font-weight:700;
  font-size:12px;
  border:1px solid rgba(255,255,255,0.03);
  cursor:pointer;
}
.nav .icon{
  width:36px;height:36px;border-radius:8px;background:linear-gradient(180deg,#2a2036,#32263f);display:flex;align-items:center;justify-content:center;color:#fff;font-size:18px;
}
/* active nav styling like image */
.nav.active{
  background:linear-gradient(180deg,#35233f,#3e294f);
  color:#ffdd7a;
  box-shadow:0 8px 20px rgba(0,0,0,0.6);
  border:1px solid rgba(255,187,90,0.15);
}
.nav.active .icon{
  background:linear-gradient(90deg,#4f2f5a,#5f3b6a);
  box-shadow:inset 0 -2px 0 rgba(0,0,0,0.2);
  color:#ffd98a;
}

/* plus floating text styling (reused) */
.plus{
  position:fixed;
  color:#ffffff;
  font-weight:700;
  font-size:22px;
  animation:floatUp .9s ease forwards;
  pointer-events:none;
  z-index:9999;
}
@keyframes floatUp{from{opacity:1;transform:translateY(0)} to{opacity:0;transform:translateY(-80px)}}

/* account panel & modal/backdrop keep existing z-index (unchanged elsewhere) */
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:200;}
.modal{width:92%;max-width:420px;background:linear-gradient(180deg,#1f1826,#2a2237);border-radius:12px;padding:18px;color:#fff;box-shadow:0 8px 30px rgba(0,0,0,.6);}

/* small responsive tweak */
@media (max-width:420px){
  .coin{width:260px;height:260px}
  .coin-wrap{width:300px;height:300px}
  .status-row{left:14px;bottom:100px}
  .bottom{gap:8px}
}
</style>
</head>

<body>
<div class="container">

  <header class="header">
    <div class="header-left">
      <div class="title-row">
        <div class="app-title">NJR (Nova Joint Reserve)</div>
        <div class="points-pill"><span id="points">1525</span> <img src="coin-mini.png" alt="coin" style="width:18px;height:18px"></div>
      </div>

      <div class="top-buttons" aria-hidden="false">
        <div class="top-btn">ü•â Bronze</div>
        <div class="top-btn">üîó Connect Wallet</div>
      </div>
    </div>

    <!-- an optional close/menu icon on the right like the image -->
    <div style="display:flex;align-items:center;gap:10px">
      <div style="width:36px;height:36px;border-radius:8px;background:transparent;display:flex;align-items:center;justify-content:center;color:#cfc1e8">‚ãÆ</div>
      <div style="width:36px;height:36px;border-radius:8px;background:transparent;display:flex;align-items:center;justify-content:center;color:#cfc1e8">‚úï</div>
    </div>
  </header>

  <main class="main" role="main">
    <div class="coin-wrap" aria-hidden="true">
      <!-- decorative background/gradient behind coin could be added here if desired -->
    </div>

    <div class="coin" id="coin" title="Tap">
      <img src="logo.png" alt="NJR">
      <div class="effect-badge" id="effectBadge" style="display:none"></div>
    </div>

    <div class="status-row" role="status" aria-live="polite">
      <div class="energy-box">‚ö° <span id="energy">474</span> / <span id="maxEnergy">500</span></div>
      <div class="boost-btn" id="openBoostBtn">üî• Boost</div>
    </div>
  </main>

  <!-- bottom nav with decorative container -->
  <div class="bottom-decor" aria-hidden="false">
    <nav class="bottom" role="navigation" aria-label="Main navigation">
      <div class="nav active" id="navEarn">
        <div class="icon">‚óè</div>
        <div>Earn</div>
      </div>

      <div class="nav" id="navTasks">
        <div class="icon">‚úÖ</div>
        <div>Tasks</div>
      </div>

      <div class="nav" id="navAccount">
        <div class="icon">üë§</div>
        <div>Account</div>
      </div>

      <div class="nav" id="navCashier">
        <div class="icon">üí≥</div>
        <div>Cashier</div>
      </div>
    </nav>
  </div>

</div>

<!-- MODAL (unchanged structure, IDs preserved) -->
<div class="modal-backdrop" id="modalBackdrop">
  <div class="modal" role="dialog" aria-modal="true">
    <h3>Boosts & Purchases</h3>
    <div class="small">Your daily boosters: <span id="dailyInfo">‚Äî</span></div>

    <div style="margin-top:12px;">
      <div style="display:flex;gap:8px;">
        <div class="booster-btn" id="btnFullTank">
          <div style="font-weight:800">‚ö° Full Tank</div>
          <div class="small">Refills energy instantly (3/day)</div>
        </div>
        <div class="booster-btn" id="btnTaping">
          <div style="font-weight:800">üî• Taping Guru</div>
          <div class="small">Tap multiplier √ó2 for 10 seconds (3/day)</div>
        </div>
      </div>

      <div style="margin-top:14px;">
        <div style="font-weight:700;margin-bottom:6px;">Boost √ó2 (Buy duration)</div>
        <div class="purchase-options">
          <div class="option" data-price="0.5" data-duration="3600"><div>√ó2 ‚Äî 1 hour</div><div>$0.5</div></div>
          <div class="option" data-price="1" data-duration="14400"><div>√ó2 ‚Äî 4 hours</div><div>$1</div></div>
          <div class="option" data-price="4" data-duration="28800"><div>√ó2 ‚Äî 8 hours</div><div>$4</div></div>
        </div>
      </div>

      <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end;">
        <button class="btn ghost" id="closeModal">Cancel</button>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast" aria-hidden="true"></div>

<!-- ÿ≠ÿßŸÅÿ∏ÿ™ ÿπŸÑŸâ ŸÉÿßŸÖŸÑ ÿ≥ŸÉÿ±ÿ®ÿ™ ÿßŸÑÿµŸÅÿ≠ÿ© ŸÉŸÖÿß ŸáŸä (ŸÑŸÖ ÿ£ÿ∫Ÿäÿ± ÿßŸÑŸÖŸÜÿ∑ŸÇ) -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
// --- ŸÑŸÖ ÿ£ÿ™ÿØÿÆŸÑ ŸÅŸä ŸÖŸÜÿ∑ŸÇ ÿßŸÑÿπŸÖŸÑ ---
// ŸÉŸàÿØ ÿßŸÑŸàÿßÿ¨Ÿáÿ© ÿßŸÑÿ£ÿµŸÑŸä (ÿßŸÑÿ∞Ÿä Ÿäÿπÿ™ŸÖÿØ ÿπŸÑŸäŸá ÿßŸÑÿÆÿßÿØŸÖ) ŸäÿπŸÖŸÑ ÿØŸàŸÜ ÿ™ÿ∫ŸäŸäÿ±. 
// ÿ£ÿ∂ŸÅÿ™ ŸÅŸÇÿ∑ ÿ±ÿ®ÿ∑Ÿãÿß ÿÆŸÅŸäŸÅŸãÿß ŸÑŸÑÿ£ŸäŸÇŸàŸÜÿßÿ™ ÿ£ÿ≥ŸÅŸÑ ŸÉŸä ÿ™ÿπŸÖŸÑ ÿßŸÑÿ™ŸÜŸÇŸÑÿßÿ™ ÿßŸÑÿ®ÿ≥Ÿäÿ∑ÿ© ŸÑŸÑŸÄ UI.
// ÿ™ÿ£ŸÉÿØ ÿ£ŸÜ ÿ®ŸÇŸäÿ© ŸÖŸÑŸÅÿßÿ™ŸÉ ÿßŸÑÿÆÿØŸÖŸäÿ© ŸÖŸàÿ¨ŸàÿØÿ© ŸÉŸÖÿß ŸáŸä (endpoints, /tap, /boost/*, /state, /daily-info...)

const tg = window.Telegram?.WebApp;
if(tg) tg.ready();

const userId = (tg && tg.initDataUnsafe?.user?.id) ? tg.initDataUnsafe.user.id : "guest";
/* ÿßŸÑŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ÿßŸÑÿ™Ÿä Ÿäÿπÿ™ŸÖÿØ ÿπŸÑŸäŸáÿß ÿ®ÿßŸÇŸä ÿßŸÑÿ≥ŸÉÿ±ÿ®ÿ™ (ÿßŸÜÿµÿ≠ ÿ®ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ÿ≥ŸÉÿ±ÿ®ÿ™ŸÉ ÿßŸÑÿ£ÿµŸÑŸä ŸáŸÜÿß ÿ£Ÿà ÿ•ÿ®ŸÇÿßÿ° ÿßŸÑŸÉŸàÿØ ÿßŸÑÿ™ÿßŸÑŸä ŸÖÿ™ÿ∑ÿßÿ®ŸÇ ŸÖÿπ ŸÖÿ¥ÿ±ŸàÿπŸÉ) */
let energy = 0, maxEnergy = 500, points = 0, boost = 1;
let displayedEnergy = 0, displayedPoints = 0;
let pendingGain = 0;
let initialLoaded = false;
let activeEffects = [];
let localMultiplier = 1;

// ÿπŸÜÿßÿµÿ± DOM
const pointsEl = document.getElementById('points');
const energyEl = document.getElementById('energy');
const maxEnergyEl = document.getElementById('maxEnergy');
const coinEl = document.getElementById('coin');
const toastEl = document.getElementById('toast');
const modalBackdrop = document.getElementById('modalBackdrop');
const openBoostBtn = document.getElementById('openBoostBtn');
const closeModalBtn = document.getElementById('closeModal');
const btnTaping = document.getElementById('btnTaping');
const btnFullTank = document.getElementById('btnFullTank');

// Helper toast
function showToast(msg, timeout=1800){
  if(!toastEl) return;
  toastEl.innerText = msg;
  toastEl.style.display = 'block';
  clearTimeout(toastEl._to);
  toastEl._to = setTimeout(()=> toastEl.style.display = 'none', timeout);
}

// keep a simple UI update function (visual only)
function updateUI(){
  pointsEl.innerText = Math.floor(displayedPoints || points || 0);
  energyEl.innerText = Math.max(0, Math.floor(displayedEnergy || energy || 0));
  maxEnergyEl.innerText = maxEnergy || 500;
}

// ÿ®ÿ≥Ÿäÿ∑ÿ©: ÿ™ŸÅÿπŸäŸÑ ŸÅÿ™ÿ≠/ÿßÿ∫ŸÑÿßŸÇ ÿßŸÑŸÖŸàÿØÿßŸÑ
if(openBoostBtn) openBoostBtn.addEventListener('click', ()=>{
  // ÿßÿ∑ŸÑÿ® info ŸäŸàŸÖŸä ŸÖŸÜ ÿßŸÑÿÆÿßÿØŸÖ (ÿ•ÿ∞ÿß ŸÖÿ™ÿßÿ≠)
  fetch(`/daily-info/${userId}`).then(r=>r.json()).then(d=>{
    if(d && d.success){
      const tapRem = Math.max(0, 3 - (d.taping_used||0));
      const ftRem = Math.max(0, 3 - (d.fulltank_used||0));
      document.getElementById('dailyInfo').innerText = `Taping ${tapRem}/3 ¬∑ FullTank ${ftRem}/3`;
    } else {
      document.getElementById('dailyInfo').innerText = `Taping 3/3 ¬∑ FullTank 3/3`;
    }
    modalBackdrop.style.display = 'flex';
  }).catch(()=>{ modalBackdrop.style.display='flex'; });
});
if(closeModalBtn) closeModalBtn.addEventListener('click', ()=> modalBackdrop.style.display = 'none');

// ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ≤ÿ±ŸäŸÜ (ÿßŸÑŸÖŸÜÿ∑ŸÇ ÿßŸÑÿÆŸÑŸÅŸä ŸÖŸàÿ¨ŸàÿØ ŸÅŸä bot.js ŸÉŸÖÿß ÿ∑ŸÑÿ®ÿ™ ÿ≥ÿßÿ®ŸÇŸãÿß)
if(btnTaping){
  btnTaping.addEventListener('click', async ()=>{
    try {
      const res = await fetch('/boost/taping', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({user_id: userId})});
      const j = await res.json();
      if(!j.success) return;
      // ŸÜÿ∑ÿ®ŸÇ ŸÖÿ∂ÿßÿπŸÅ ŸÖÿ≠ŸÑŸäŸãÿß ÿßÿ≥ÿ™ÿ¨ÿßÿ®ÿ© ÿ≥ÿ±Ÿäÿπÿ©ÿå ŸàÿßŸÑÿÆÿßÿØŸÖ ÿ≥Ÿäÿ§ŸÉÿØ ÿßŸÑÿ≠ÿßŸÑÿ© ŸÑÿßÿ≠ŸÇŸãÿß ÿπÿ®ÿ± pollState
      localMultiplier = 2;
      // ŸÑÿß ŸÜÿ∏Ÿáÿ± ÿπÿØÿßÿØ ÿßŸÑŸÄ10s ÿπŸÑŸâ ÿßŸÑŸàÿßÿ¨Ÿáÿ© (ŸäÿπŸÖŸÑ ŸÅŸä ÿßŸÑÿÆŸÑŸÅŸäÿ© ŸÅŸÇÿ∑)
      modalBackdrop.style.display = 'none';
      // ÿ™ÿ≠ÿØŸäÿ´ ŸÖÿ§ÿ¥ÿ±ÿßÿ™ ÿßŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ Ÿäÿ≠ÿØÿ´ ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ÿ±ÿØ ÿßŸÑÿÆÿßÿØŸÖ
      if(j.taping_used !== undefined){
        const rem = Math.max(0, 3 - j.taping_used);
        document.getElementById('dailyInfo').innerText = `Taping ${rem}/3 ¬∑ FullTank ‚Äî`;
      }
    } catch(e){}
  });
}
if(btnFullTank){
  btnFullTank.addEventListener('click', async ()=>{
    try {
      const res = await fetch('/boost/full', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({user_id: userId})});
      const j = await res.json();
      if(!j.success) return;
      // ŸÜÿ≠ÿØÿ´ ÿßŸÑÿ∑ÿßŸÇÿ© ŸÖÿ≠ŸÑŸäŸãÿß
      displayedEnergy = j.energy || displayedEnergy;
      updateUI();
      modalBackdrop.style.display = 'none';
      // ŸÑÿß ŸÜÿ∏Ÿáÿ± ÿ±ÿ≥ÿßŸÑÿ© ÿ™ŸÅÿπŸäŸÑ ÿπŸÑŸâ ÿßŸÑÿ¥ÿßÿ¥ÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ© ŸÉŸÖÿß ÿ∑ŸÑÿ®ÿ™
    } catch(e){}
  });
}

// Tap visual + optimistic behavior (Ÿäÿ≥ÿ™ÿÆÿØŸÖ ŸÜŸÅÿ≥ /tap endpoint ŸÑÿØŸäŸÉ)
coinEl.addEventListener('click', (e)=>{
  if(Math.floor(displayedEnergy) <= 0) return;
  const value = boost * localMultiplier;
  const p = document.createElement('div');
  p.className = 'plus';
  p.innerText = `+${value}`;
  p.style.left = `${e.clientX}px`;
  p.style.top = `${e.clientY}px`;
  p.style.transform = 'translate(-50%,-50%)';
  document.body.appendChild(p);
  setTimeout(()=>p.remove(),900);
  if(navigator.vibrate) navigator.vibrate(20);

  displayedEnergy = Math.max(0, displayedEnergy - 1);
  pendingGain += value;
  displayedPoints = points + pendingGain;
  updateUI();

  fetch('/tap', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({user_id: userId})})
    .then(r=>r.json())
    .then(data=>{
      if(!data.success){ /* revert by fetching state if desired */ return; }
      displayedEnergy = data.energy;
      points += data.gain;
      pendingGain = Math.max(0, pendingGain - data.gain);
      updateUI();
    }).catch(()=>{/* ignore network errors here */});
});

// basic polling to sync server state (kept minimal to avoid interfering)
async function pollState(){
  try{
    const r = await fetch(`/state/${userId}`);
    const j = await r.json();
    if(!j || !j.success) return;
    energy = j.energy || energy;
    maxEnergy = j.maxEnergy || maxEnergy;
    points = j.points || points;
    activeEffects = (j.active_effects || []).filter(e=> (e.expires_at||0) > Date.now());
    // adjust local multiplier according to active effects (server authoritative)
    const now = Date.now();
    const has = activeEffects.some(e=> (e.type==='taping' || e.type==='x2') && e.expires_at > now);
    localMultiplier = has ? 2 : 1;
    // reconcile display
    displayedEnergy = energy;
    displayedPoints = points;
    updateUI();
  }catch(e){}
}
setInterval(pollState, 2000);
pollState();

// bottom nav simple interactions (visual only)
document.getElementById('navEarn').addEventListener('click', ()=> { document.querySelectorAll('.bottom .nav').forEach(x=>x.classList.remove('active')); document.getElementById('navEarn').classList.add('active'); });
document.getElementById('navTasks').addEventListener('click', ()=> { document.querySelectorAll('.bottom .nav').forEach(x=>x.classList.remove('active')); document.getElementById('navTasks').classList.add('active'); });
document.getElementById('navAccount').addEventListener('click', ()=> { document.querySelectorAll('.bottom .nav').forEach(x=>x.classList.remove('active')); document.getElementById('navAccount').classList.add('active'); /* open account panel if your original script uses .bottom .nav:nth-child(3) this remains the 3rd */ });
document.getElementById('navCashier').addEventListener('click', ()=> { document.querySelectorAll('.bottom .nav').forEach(x=>x.classList.remove('active')); document.getElementById('navCashier').classList.add('active'); });

</script>

</body>
</html>
