<!doctype html>
<html lang="ar">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>NJR</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

<style>
/* Ù‚ÙˆØ§Ø¹Ø¯ Ø£Ø³Ø§Ø³ÙŠØ© + ØªØµÙ…ÙŠÙ… Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„ØµÙˆØ±Ø© */
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color: transparent;}
html,body{width:100%;height:100%;overflow:hidden;font-family:'Poppins',system-ui;background: radial-gradient(circle at top left,#3a2b4b 0%, #241a30 35%, #141019 100%);color:#fff;direction:rtl}
.top{display:flex;align-items:center;justify-content:space-between;padding:18px 18px 8px;gap:12px;}
.title-pill{
  flex:1;
  display:flex;
  align-items:center;
  justify-content:space-between;
  background:linear-gradient(90deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
  padding:12px 18px;
  border-radius:12px;
  font-weight:700;
  color:#efe9ff;
  box-shadow: inset 0 -2px 0 rgba(0,0,0,0.2);
}
.top-right{
  display:flex;
  gap:10px;
  align-items:center;
}
.pill-small{
  background:linear-gradient(90deg,#3a2743,#463254);
  color:#ffdd7a;
  padding:8px 10px;
  border-radius:12px;
  font-weight:700;
  display:flex;
  align-items:center;
  gap:8px;
  min-width:86px;
  justify-content:center;
  border:1px solid rgba(255,255,255,0.03);
}

/* small top buttons (bronze / connect) */
.top-buttons{
  display:flex;
  gap:12px;
  margin-top:10px;
}
.top-btn{
  background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  padding:10px 14px;
  border-radius:12px;
  color:#ddd;
  display:inline-flex;
  align-items:center;
  gap:10px;
  font-weight:700;
  border:1px solid rgba(255,255,255,0.03);
}

/* ÙˆØ³Ø· Ø§Ù„ØµÙØ­Ø© */
.center{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;position:relative;padding-bottom:40px;}
.coin-large-wrap{
  width:100%;
  display:flex;
  align-items:center;
  justify-content:center;
  margin-top:8px;
  pointer-events:none;
}
.coin{
  width:360px;
  height:360px;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  transition:transform .08s ease;
  user-select:none;
  position:relative;
  z-index:5;
  pointer-events:auto;
}
.coin img{width:100%;height:100%;object-fit:contain;pointer-events:none;user-select:none;}

/* energy + boost row positioned under coin */
.energy-boost{
  position:relative;
  width:100%;
  max-width:760px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:22px 28px 0 28px;
  gap:12px;
}
.box{background:rgba(255,255,255,.04);padding:12px 18px;border-radius:12px;font-weight:700;color:#fff;border:1px solid rgba(255,255,255,0.03);}
.boost{ color:#ff9b2f; background:linear-gradient(90deg,#35213a,#40223f); }

/* Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø³ÙÙ„ÙŠ - Ù…Ø¹ Ø®Ù„ÙÙŠØ© Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„ØµÙˆØ±Ø© */
.bottom{
  position:fixed;
  bottom:12px;
  left:12px;
  right:12px;
  height:96px;
  border-radius:18px;
  padding:12px;
  display:flex;
  align-items:flex-end;
  justify-content:center;
  background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  box-shadow:0 12px 40px rgba(0,0,0,0.6);
  border:1px solid rgba(255,255,255,0.02);
  z-index:4;
}
.nav-row{
  width:96%;
  max-width:820px;
  display:flex;
  gap:16px;
  justify-content:space-between;
  align-items:center;
}
.nav{
  flex:1;
  max-width:140px;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:8px;
  padding:10px 8px;
  border-radius:12px;
  background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.01));
  color:#cfc1e8;
  font-weight:700;
  font-size:13px;
  border:1px solid rgba(255,255,255,0.03);
  cursor:pointer;
}
.nav .icon{
  width:44px;height:44px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,#2a2036,#32263f);color:#fff;font-size:18px;
}
.nav.active{
  background:linear-gradient(180deg,#3a2743,#3f2b52);
  color:#ffd88a;
  border:1px solid rgba(255,187,90,0.12);
  box-shadow:0 8px 18px rgba(0,0,0,0.5);
}
.nav.active .icon{background:linear-gradient(90deg,#4f2f5a,#5f3b6a);color:#ffd98a;}

/* modal + badge + toast (kept as before) */
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:200;}
.modal{width:92%;max-width:420px;background:linear-gradient(180deg,#1f1826,#2a2237);border-radius:12px;padding:18px;color:#fff;box-shadow:0 8px 30px rgba(0,0,0,.6);}

.effect-badge{position:absolute;top:8px;right:8px;background:rgba(0,0,0,.4);padding:6px 8px;border-radius:10px;font-size:12px;border:1px solid rgba(255,255,255,.06);display:none;}
.plus{position:fixed;color:#ffffff;font-weight:700;font-size:22px;animation:floatUp .9s ease forwards;pointer-events:none;z-index:9999;}
@keyframes floatUp{from{opacity:1;transform:translateY(0)} to{opacity:0;transform:translateY(-80px)}}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:110px;background:#111;padding:10px 14px;border-radius:8px;color:#fff;box-shadow:0 6px 20px rgba(0,0,0,.6);display:none;z-index:300}

/* responsive tweaks */
@media (max-width:420px){
  .coin{width:260px;height:260px}
  .energy-boost{padding:12px}
  .nav .icon{width:40px;height:40px}
}
</style>
</head>

<body>

<!-- Ø±Ø£Ø³ Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„ØµÙˆØ±Ø© -->
<div class="top">
  <div class="title-pill" aria-label="title">
    <div style="display:flex;align-items:center;gap:12px;">
      <div style="font-weight:800">NJR (Nova Joint Reserve)</div>
    </div>
    <div class="pill-small" aria-hidden="true"><img src="coin-mini.png" alt="" style="width:16px;height:16px"> <span id="points">156.00</span></div>
  </div>
</div>

<!-- Ø£Ø²Ø±Ø§Ø± ØµØºÙŠØ±Ø© ØªØ­Øª Ø§Ù„Ø¹Ù†ÙˆØ§Ù† -->
<div style="padding:0 18px 8px">
  <div class="top-buttons" role="toolbar" aria-label="top actions">
    <div class="top-btn">ğŸ¥‰ Bronze <span style="margin-inline-start:8px">â€º</span></div>
    <div class="top-btn">ğŸ”— Connect Wallet <span style="margin-inline-start:8px">â€º</span></div>
  </div>
</div>

<!-- Ø§Ù„ÙˆØ³Ø· Ù…Ø¹ Ø¹Ù…Ù„Ø© ÙƒØ¨ÙŠØ±Ø© -->
<div class="center">
  <div class="coin-large-wrap" aria-hidden="true"></div>

  <div class="coin" id="coin" title="Tap">
    <img src="logo.png" alt="NJR">
    <div class="effect-badge" id="effectBadge" style="display:none"></div>
  </div>

  <div class="energy-boost" role="status" aria-live="polite">
    <div class="box">âš¡ <span id="energy">412</span> / <span id="maxEnergy">500</span></div>
    <div class="box boost" id="openBoostBtn">ğŸ”¥ Boost</div>
  </div>
</div>

<!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø³ÙÙ„ÙŠ - Skills Ù…Ø­Ø°ÙˆÙ ÙƒÙ…Ø§ Ø·Ù„Ø¨Øª -->
<div class="bottom" role="navigation" aria-label="main nav">
  <div class="nav-row">
    <div class="nav active" id="navEarn">
      <div class="icon">â—</div>
      <div>Earn</div>
    </div>

    <div class="nav" id="navTasks">
      <div class="icon">âœ…</div>
      <div>Tasks</div>
    </div>

    <div class="nav" id="navAccount">
      <div class="icon">ğŸ‘¤</div>
      <div>Account</div>
    </div>

    <div class="nav" id="navCashier">
      <div class="icon">ğŸ’³</div>
      <div>Cashier</div>
    </div>
  </div>
</div>

<!-- MODAL Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙˆØ§Ù„Ù€ IDs ÙƒÙ…Ø§ ÙÙŠ ÙƒÙˆØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„ØªÙˆØ§ÙÙ‚ -->
<div class="modal-backdrop" id="modalBackdrop">
  <div class="modal" role="dialog" aria-modal="true">
    <h3>Boosts & Purchases</h3>
    <div class="small">Your daily boosters: <span id="dailyInfo">â€”</span></div>

    <div style="margin-top:12px;">
      <div style="display:flex;gap:8px;">
        <div class="booster-btn" id="btnFullTank" role="button" aria-pressed="false" tabindex="0">
          <div style="font-weight:800">âš¡ Full Tank</div>
          <div class="small">Refills energy instantly (<span id="fullTankRemaining">3/3</span>)</div>
        </div>
        <div class="booster-btn" id="btnTaping" role="button" aria-pressed="false" tabindex="0">
          <div style="font-weight:800">ğŸ”¥ Taping Guru</div>
          <div class="small">Tap multiplier Ã—2 (<span id="tapingRemaining">3/3</span>)</div>
        </div>
      </div>

      <div style="margin-top:14px;">
        <div style="font-weight:700;margin-bottom:6px;">Boost Ã—2 (Buy duration)</div>
        <div class="purchase-options">
          <div class="option" data-price="0.5" data-duration="3600"><div>Ã—2 â€” 1 hour</div><div>$0.5</div></div>
          <div class="option" data-price="1" data-duration="14400"><div>Ã—2 â€” 4 hours</div><div>$1</div></div>
          <div class="option" data-price="4" data-duration="28800"><div>Ã—2 â€” 8 hours</div><div>$4</div></div>
        </div>
      </div>

      <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end;">
        <button class="btn ghost" id="closeModal">Cancel</button>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- Ø§Ù„Ø³ÙƒØ±Ø¨ØªØ§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ© (Ù„Ù… Ø£ØºÙŠÙ‘Ø± Ø§Ù„Ù…Ù†Ø·Ù‚ - Ø§Ø­ØªÙØ¸Øª Ø¨ÙƒÙ„ Ø§Ù„Ù€ IDs Ùˆendpoints) -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
const tg = window.Telegram.WebApp;
if(tg) tg.ready();

const userId = tg.initDataUnsafe?.user?.id || "guest";
let energy=0, maxEnergy=500, points=0, boost=1;
let displayedEnergy=0, displayedPoints=0;
let pendingGain=0;
let initialLoaded=false;

// activeEffects from server: {type:"taping"|"x2", expires_at: timestamp (ms)}
let activeEffects = [];
let localMultiplier = 1; // used for client immediate tap multiplier

// helper: toast
function showToast(msg, timeout=2000){
  const t = document.getElementById("toast");
  t.innerText = msg;
  t.style.display = "block";
  clearTimeout(t._to);
  t._to = setTimeout(()=> t.style.display = "none", timeout);
}

// animate number
function animateNumber(from,to,onStep,duration=400){
  if(from===to){ onStep(to); return Promise.resolve(); }
  return new Promise(resolve=>{
    const start = performance.now();
    const sign = to>from?1:-1;
    const range = Math.abs(to-from);
    function step(now){
      const t = Math.min(1,(now-start)/duration);
      const eased = 1 - Math.pow(1 - t, 2);
      const current = from + sign * Math.round(range * eased);
      onStep(current);
      if(t<1) requestAnimationFrame(step);
      else { onStep(to); resolve(); }
    }
    requestAnimationFrame(step);
  });
}

function updateUI(){
  document.getElementById("energy").innerText = Math.max(0, Math.floor(displayedEnergy));
  document.getElementById("maxEnergy").innerText = maxEnergy;
  document.getElementById("points").innerText = Math.floor(displayedPoints);
  // we intentionally DO NOT show the taping countdown on the main screen (runs in background)
}

// ====== state polling ======
let pollInterval = 2000; let pollTimer=null;
async function fetchStateOnce(){
  try{
    const r = await fetch(`/state/${userId}`);
    return await r.json();
  }catch(e){ console.warn("state fetch failed",e); return null; }
}

async function pollState(){
  const data = await fetchStateOnce();
  if(!data || !data.success) return;
  const prevPoints = points;
  energy = data.energy; maxEnergy = data.maxEnergy; points = data.points;
  activeEffects = (data.active_effects || []).map(e=> ({...e, expires_at: e.expires_at}));
  const confirmedGain = Math.max(0, points - prevPoints);
  pendingGain = Math.max(0, pendingGain - confirmedGain);
  const targetDisplayedPoints = points + pendingGain;
  if(!initialLoaded){
    displayedEnergy = energy; displayedPoints = targetDisplayedPoints; initialLoaded=true; updateUI();
  } else {
    animateNumber(displayedEnergy, energy, v=>{ displayedEnergy = v; updateUI(); }, 300);
    animateNumber(displayedPoints, targetDisplayedPoints, v=>{ displayedPoints = v; updateUI(); }, 300);
  }
  const now = Date.now();
  const tapEffect = activeEffects.find(e=> e.type === 'taping' && e.expires_at > now);
  const x2Effect = activeEffects.find(e=> e.type === 'x2' && e.expires_at > now);
  localMultiplier = (tapEffect || x2Effect) ? 2 : 1;
}

function startPolling(){
  if(pollTimer) return;
  pollState();
  pollTimer = setInterval(pollState, pollInterval);
  document.addEventListener('visibilitychange', ()=>{
    if(document.hidden){ clearInterval(pollTimer); pollTimer=null; }
    else startPolling();
  });
}
startPolling();

// heartbeat
async function sendHeartbeat() {
  if (!userId || String(userId) === 'guest') return;
  try {
    await fetch(`/heartbeat/${userId}`, { method: 'POST' });
  } catch (e) {
    console.warn('heartbeat failed', e);
  }
}
sendHeartbeat();

// boost modal handling
const modalBackdrop = document.getElementById("modalBackdrop");
const tapingRemainingEl = document.getElementById('tapingRemaining');
const fullTankRemainingEl = document.getElementById('fullTankRemaining');

document.getElementById("openBoostBtn").addEventListener("click", ()=> {
  fetch(`/daily-info/${userId}`).then(r=>r.json()).then(d=>{
    if(d?.success){
      const tapUsed = d.taping_used || 0;
      const ftUsed = d.fulltank_used || 0;
      const tapRem = Math.max(0, 3 - tapUsed);
      const ftRem = Math.max(0, 3 - ftUsed);
      document.getElementById("dailyInfo").innerText = `Taping ${tapRem}/3 Â· FullTank ${ftRem}/3`;
      if(tapingRemainingEl) tapingRemainingEl.innerText = `${tapRem}/3`;
      if(fullTankRemainingEl) fullTankRemainingEl.innerText = `${ftRem}/3`;
    } else {
      document.getElementById("dailyInfo").innerText = `Taping 3/3 Â· FullTank 3/3`;
      if(tapingRemainingEl) tapingRemainingEl.innerText = `3/3`;
      if(fullTankRemainingEl) fullTankRemainingEl.innerText = `3/3`;
    }
    modalBackdrop.style.display = "flex";
  }).catch(()=>{
    modalBackdrop.style.display="flex";
    if(tapingRemainingEl) tapingRemainingEl.innerText = `3/3`;
    if(fullTankRemainingEl) fullTankRemainingEl.innerText = `3/3`;
    document.getElementById("dailyInfo").innerText = `Taping 3/3 Â· FullTank 3/3`;
  });
});
document.getElementById("closeModal").addEventListener("click", ()=> modalBackdrop.style.display="none");

// Full Tank
document.getElementById("btnFullTank").addEventListener("click", async ()=>{
  try {
    const res = await fetch("/boost/full", {method:"POST",headers:{"Content-Type":"application/json"}, body: JSON.stringify({user_id:userId})});
    const data = await res.json();
    if(!data.success){ return; }
    energy = data.energy; points = data.points || points;
    pendingGain = 0;
    animateNumber(displayedEnergy, energy, v=>{ displayedEnergy=v; updateUI(); }, 300);
    animateNumber(displayedPoints, points, v=>{ displayedPoints=v; updateUI(); }, 300);
    if(typeof data.fulltank_used !== 'undefined'){
      const rem = Math.max(0, 3 - data.fulltank_used);
      if(fullTankRemainingEl) fullTankRemainingEl.innerText = `${rem}/3`;
      document.getElementById("dailyInfo").innerText = `Taping ${tapingRemainingEl?.innerText || '3/3'} Â· FullTank ${fullTankRemainingEl?.innerText || '3/3'}`;
    }
    modalBackdrop.style.display = "none";
  } catch (err) {
    console.warn("Full Tank activation error", err);
  }
});

// Taping Guru (10s Ã—2) - background-only countdown (no main UI badge shown)
document.getElementById("btnTaping").addEventListener("click", async ()=>{
  try {
    const res = await fetch("/boost/taping", {method:"POST",headers:{"Content-Type":"application/json"}, body: JSON.stringify({user_id:userId})});
    const data = await res.json();
    if(!data.success){ return; }
    localMultiplier = 2;
    if(typeof data.taping_used !== 'undefined'){
      const rem = Math.max(0, 3 - data.taping_used);
      if(tapingRemainingEl) tapingRemainingEl.innerText = `${rem}/3`;
      document.getElementById("dailyInfo").innerText = `Taping ${tapingRemainingEl?.innerText || '3/3'} Â· FullTank ${fullTankRemainingEl?.innerText || '3/3'}`;
    }
    modalBackdrop.style.display = "none";
  } catch (err) {
    console.warn("Taping activation error", err);
  }
});

// purchase options (unchanged)
document.querySelectorAll('.purchase-options .option').forEach(opt=>{
  opt.addEventListener('click', async ()=> {
    const price = parseFloat(opt.dataset.price);
    const duration = parseInt(opt.dataset.duration,10);
    showToast("Creating invoice...");
    const r = await fetch("/purchase", {method:"POST",headers:{"Content-Type":"application/json"}, body: JSON.stringify({ user_id: userId, price, duration })});
    const j = await r.json();
    if(!j.success){ showToast(j.message || "Invoice creation error"); return; }
    if(j.payment_url){ window.open(j.payment_url, "_blank"); }
    showToast("Waiting for payment confirmation...");
    const purchaseId = j.purchase_id;
    const start = Date.now();
    const timeout = 2*60*1000;
    const poll = setInterval(async ()=>{
      const sres = await fetch(`/purchase/status/${purchaseId}`);
      const sj = await sres.json();
      if(sj.success && sj.status === 'paid'){
        clearInterval(poll);
        showToast("Payment confirmed. Ã—2 activated instantly");
        await pollState();
        modalBackdrop.style.display = "none";
      } else if(Date.now() - start > timeout){
        clearInterval(poll);
        showToast("Payment time expired or the user did not complete the payment");
      }
    }, 2000);
  });
});

// ====== TAP logic (uses localMultiplier) ======
const coin = document.getElementById("coin");
coin.addEventListener("click", (e)=>{
  if(Math.floor(displayedEnergy) <= 0) return;
  const p = document.createElement("div");
  p.className = "plus";
  const value = boost * localMultiplier;
  p.innerText = `+${value}`;
  p.style.left = `${e.clientX}px`;
  p.style.top = `${e.clientY}px`;
  p.style.transform = 'translate(-50%,-50%)';
  p.style.position = 'fixed';
  document.body.appendChild(p);
  setTimeout(()=>p.remove(),900);
  if(navigator.vibrate) navigator.vibrate(20);

  displayedEnergy = Math.max(0, displayedEnergy - 1);
  pendingGain += value;
  displayedPoints = points + pendingGain;
  updateUI();

  fetch("/tap", {method:"POST",headers:{"Content-Type":"application/json"},body: JSON.stringify({user_id:userId})})
    .then(r=>r.json())
    .then(data=>{
      if(!data.success){
        pollState();
        return;
      }
      energy = data.energy;
      points += data.gain;
      pendingGain = Math.max(0, pendingGain - data.gain);
      animateNumber(displayedEnergy, energy, v=>{ displayedEnergy=v; updateUI(); }, 300);
      animateNumber(displayedPoints, points + pendingGain, v=>{ displayedPoints=v; updateUI(); }, 300);
    }).catch(err=>{
      console.warn("tap error",err);
      pollState();
    });
});

// start
updateUI();
</script>

<!-- ACCOUNT PANEL and Policy content preserved (styles/ids unchanged) -->
<style>
/* Account panel styles (kept same as original to avoid breaking logic) */
.account-panel-backdrop{
  position:fixed;inset:0;display:none;align-items:flex-start;justify-content:center;
  padding-top:40px;z-index:400;background:linear-gradient(180deg,rgba(6,6,7,.45),rgba(6,6,7,.7));
  backdrop-filter: blur(6px);
}
.account-panel{
  width:92%;max-width:520px;margin:0 auto;background:linear-gradient(180deg,#241d2b,#2d2436);
  border-radius:14px;padding:14px 14px 20px;color:#fff;box-shadow:0 12px 40px rgba(0,0,0,.6);
  border:1px solid rgba(255,255,255,.03);
  font-family: 'Poppins', system-ui;
}
/* ... Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø£Ù†Ù…Ø§Ø· ÙƒÙ…Ø§ ÙÙŠ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø£ØµÙ„ÙŠ (Ù…Ø­ØªÙØ¸Ø©) ... */
</style>

<!-- Account panel HTML (kept) -->
<div class="account-panel-backdrop" id="accountPanelBackdrop" aria-hidden="true">
  <div class="account-panel" role="dialog" aria-modal="true" aria-labelledby="accountTitle">
    <div style="position:relative;">
      <div id="accountTitle" style="font-weight:800;font-size:16px;color:#fff;margin-bottom:8px;">Account</div>
      <div class="close-panel" id="closeAccountPanel" role="button" tabindex="0">âœ•</div>
    </div>

    <div class="account-top-tabs" role="tablist" aria-label="Account tabs">
      <div class="account-tab-btn" data-tab="ref">Ref</div>
      <div class="account-tab-btn active" data-tab="stats">Stats</div>
      <div class="account-tab-btn" data-tab="settings">Settings</div>
    </div>

    <div class="account-section" id="accountSection">
      <div class="account-content" data-content="stats" style="display:block;">
        <div class="account-stats">
          <div class="stat-row">
            <div class="stat-title">Total Share Balance:</div>
            <div class="stat-value" id="statShare">â€”</div>
          </div>
          <div class="stat-row">
            <div class="stat-title">Total Touches:</div>
            <div class="stat-value" id="statTouches">â€”</div>
          </div>
          <div class="stat-row">
            <div class="stat-title">Total Players:</div>
            <div class="stat-value" id="statPlayers">â€”</div>
          </div>
          <div class="stat-row">
            <div class="stat-title">Daily Users:</div>
            <div class="stat-value" id="statDaily">â€”</div>
          </div>
          <div class="stat-row">
            <div class="stat-title">Online Players:</div>
            <div class="stat-value" id="statOnline">â€”</div>
          </div>
        </div>
      </div>

      <div class="account-content" data-content="ref" style="display:none;">
        <div class="account-small">My ref bonus: <span id="myRefBonus">0</span></div>
        <div class="account-small">My ref: <span id="myRefCount">0</span></div>

        <div class="invite-card" style="margin-top:8px;">
          <div class="invite-left">
            <div class="invite-label">My invite link:</div>
            <div class="invite-link" id="inviteLink">â€”</div>
          </div>
          <div>
            <button class="copy-btn" id="copyInviteBtn">Copy</button>
          </div>
        </div>

        <div class="ref-list">
          <div style="font-weight:800;margin-top:12px;">My Referals list:</div>
          <div class="no-ref" id="noRefText">You don't have referrals ğŸ˜­</div>
          <div id="refListContainer" style="display:none;"></div>
        </div>
      </div>

      <div class="account-content" data-content="settings" style="display:none;">
        <div class="settings-list">
          <div class="settings-item" role="button" id="privacyBtn">Privacy Policy <span>â€º</span></div>
          <div class="settings-item" role="button" id="termsBtn">Terms of Use <span>â€º</span></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Script for Account panel interactions (kept intact) -->
<script>
(function(){
  const backdrop = document.getElementById('accountPanelBackdrop');
  const closeBtn = document.getElementById('closeAccountPanel');
  const tabs = document.querySelectorAll('.account-tab-btn');
  const contents = document.querySelectorAll('.account-content');

  const myRefCountEl = document.getElementById('myRefCount');
  const myRefBonusEl = document.getElementById('myRefBonus');
  const refListContainer = document.getElementById('refListContainer');
  const noRefText = document.getElementById('noRefText');

  const accountNav = document.querySelector('.bottom .nav:nth-child(3)');
  if(accountNav){
    accountNav.addEventListener('click', ()=> openAccountPanel());
  }

  async function openAccountPanel(){
    try { if (typeof userId !== 'undefined' && String(userId) !== 'guest') await fetch(`/heartbeat/${userId}`, { method: 'POST' }); } catch(e){}
    const inviteEl = document.getElementById('inviteLink');
    try{
      const botUsername = 'NJROfficialBot';
      const uid = (typeof userId !== 'undefined') ? userId : 'guest';
      const link = `https://t.me/${botUsername}?start=r_${uid}`;
      inviteEl.innerText = link;
      inviteEl.setAttribute('data-link', link);
    }catch(e){
      inviteEl.innerText = 'https://t.me/YOUR-BOT?start=r_XXXXX';
    }

    try {
      const gres = await fetch('/global-stats');
      const g = await gres.json();
      if (g && g.success) {
        document.getElementById('statShare').innerText = (g.total_share_balance || 0).toLocaleString();
        document.getElementById('statTouches').innerText = (g.total_touches || 0).toLocaleString();
        document.getElementById('statPlayers').innerText = (g.total_players || 0).toLocaleString();
        document.getElementById('statDaily').innerText = (g.daily_users || 0).toLocaleString();
        document.getElementById('statOnline').innerText = (g.online_players || 0).toLocaleString();
      } else {
        document.getElementById('statShare').innerText = '9710702162713';
        document.getElementById('statTouches').innerText = '106 056 491 953';
        document.getElementById('statPlayers').innerText = '74 839 124';
        document.getElementById('statDaily').innerText = '22 010';
        document.getElementById('statOnline').innerText = '318';
      }
    } catch (err) {
      console.warn('global-stats fetch failed', err);
      document.getElementById('statShare').innerText = '9710702162713';
      document.getElementById('statTouches').innerText = '106 056 491 953';
      document.getElementById('statPlayers').innerText = '74 839 124';
      document.getElementById('statDaily').innerText = '22 010';
      document.getElementById('statOnline').innerText = '318';
    }

    try {
      if (typeof userId !== 'undefined' && userId && String(userId) !== 'guest') {
        const res = await fetch(`/ref/${userId}`);
        const j = await res.json();
        if (j && j.success) {
          myRefCountEl.innerText = j.referrals_count || 0;
          myRefBonusEl.innerText = j.ref_bonus_total || 0;
          if (Array.isArray(j.referrals) && j.referrals.length > 0) {
            refListContainer.innerHTML = ''; refListContainer.style.display = 'block'; noRefText.style.display = 'none';
            j.referrals.forEach(r => {
              const item = document.createElement('div');
              item.style.padding = '8px 6px';
              item.style.borderBottom = '1px solid rgba(255,255,255,.02)';
              item.style.display = 'flex';
              item.style.justifyContent = 'space-between';
              item.style.alignItems = 'center';
              const left = document.createElement('div');
              left.style.fontWeight = '700';
              left.style.color = '#fff';
              left.innerText = r.uid;
              const right = document.createElement('div');
              right.style.fontSize = '12px';
              right.style.color = '#cfc1e8';
              right.innerText = r.at ? new Date(r.at).toLocaleString() : '';
              item.appendChild(left);
              item.appendChild(right);
              refListContainer.appendChild(item);
            });
          } else {
            refListContainer.style.display = 'none';
            noRefText.style.display = 'block';
          }
        } else {
          myRefCountEl.innerText = '0';
          myRefBonusEl.innerText = '0';
          refListContainer.style.display = 'none';
          noRefText.style.display = 'block';
        }
      } else {
        myRefCountEl.innerText = '0';
        myRefBonusEl.innerText = '0';
        refListContainer.style.display = 'none';
        noRefText.style.display = 'block';
      }
    } catch (err) {
      console.warn("Failed to fetch ref info", err);
      myRefCountEl.innerText = '0';
      myRefBonusEl.innerText = '0';
      refListContainer.style.display = 'none';
      noRefText.style.display = 'block';
    }

    backdrop.style.display = 'flex';
    backdrop.setAttribute('aria-hidden','false');
  }

  function closePanel(){
    backdrop.style.display = 'none';
    backdrop.setAttribute('aria-hidden','true');
  }

  closeBtn.addEventListener('click', closePanel);
  backdrop.addEventListener('click', (e)=>{ if(e.target === backdrop) closePanel(); });

  tabs.forEach(t=>{
    t.addEventListener('click', ()=>{
      tabs.forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      const target = t.getAttribute('data-tab');
      contents.forEach(c=>{
        if(c.getAttribute('data-content') === target) c.style.display = 'block';
        else c.style.display = 'none';
      });
    });
  });

  const copyBtn = document.getElementById('copyInviteBtn');
  copyBtn.addEventListener('click', async ()=>{
    const link = document.getElementById('inviteLink').getAttribute('data-link') || document.getElementById('inviteLink').innerText;
    try{
      await navigator.clipboard.writeText(link);
      if(typeof showToast === 'function') showToast('Invite link copied');
      else alert('Invite link copied');
    }catch(e){
      if(typeof showToast === 'function') showToast('Copy failed');
      else alert('Copy failed');
    }
  });

  document.getElementById('privacyBtn').addEventListener('click', ()=>{ if(typeof showToast === 'function') showToast('Open Privacy Policy'); document.dispatchEvent(new Event('openPrivacy')); });
  document.getElementById('termsBtn').addEventListener('click', ()=>{ if(typeof showToast === 'function') showToast('Open Terms of Use'); document.dispatchEvent(new Event('openTerms')); });
})();
</script>

</body>
</html>
