<!doctype html>
<html lang="ar">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>NJR</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

<style>
/* ŸÜŸÅÿ≥ CSS ÿßŸÑÿ£ÿµŸÑŸä ŸÖÿπ ÿ•ÿ∂ÿßŸÅÿßÿ™ ŸÑŸÑŸÖŸàÿØÿßŸÑ ŸàÿßŸÑŸàŸÖŸäÿ∂ */
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color: transparent;}
html,body{width:100%;height:100%;overflow:hidden;font-family:'Poppins',system-ui;background: radial-gradient(circle at top,#2e2440,#1a1426);color:#fff;}
.top{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;}
.wallet{background:rgba(255,255,255,.08);padding:10px 14px;border-radius:14px;font-size:14px;}
.balance{display:flex;align-items:center;gap:10px;background:rgba(255,255,255,.08);padding:10px 14px;border-radius:14px;font-weight:700;}
.balance span{color:#22f3c8;}
.center{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;position:relative;}
.coin{width:280px;height:280px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:transform .1s ease;user-select:none;position:relative;}
.coin:active{transform:scale(.95);}
.coin img{width:100%;height:100%;object-fit:contain;user-select:none;pointer-events:none;}
.plus{position:absolute;color:#ffffff;font-weight:700;font-size:22px;animation:floatUp .9s ease forwards;pointer-events:none;}
@keyframes floatUp{from{opacity:1;transform:translateY(0)} to{opacity:0;transform:translateY(-80px)}}
.energy-boost{margin-top:26px;display:flex;gap:14px;}
.box{background:rgba(255,255,255,.08);padding:12px 18px;border-radius:14px;font-weight:600;}
.boost{ color:#ff9b2f }
.bottom{position:fixed;bottom:12px;left:12px;right:12px;background:rgba(255,255,255,.07);border-radius:18px;padding:10px;display:flex;justify-content:space-around;}
.nav{display:flex;flex-direction:column;align-items:center;gap:6px;font-size:13px;opacity:.7;}
.nav.active{opacity:1;color:#ffbf5a;}

/* ====== BOOST MODAL ====== */
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:200;}
.modal{width:92%;max-width:420px;background:linear-gradient(180deg,#1f1826,#2a2237);border-radius:12px;padding:18px;color:#fff;box-shadow:0 8px 30px rgba(0,0,0,.6);}
/* modal content */
.modal h3{margin-bottom:8px;}
.booster-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:12px 0;}
.booster-btn{background:rgba(255,255,255,.04);padding:12px;border-radius:10px;cursor:pointer;border:1px solid rgba(255,255,255,.03);display:flex;flex-direction:column;gap:6px;}
.small{font-size:13px;color:#bdb3d6;}
.purchase-options{display:flex;flex-direction:column;gap:8px;margin-top:10px;}
.option{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;background:rgba(255,255,255,.03);cursor:pointer;}
.btn{background:#ffbf5a;color:#000;padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:700;}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,.08);color:#fff;}

/* ===== LIGHTNING EFFECT ON COIN ===== */
.coin.lightning::after{
  content:"";
  position:absolute;inset:0;border-radius:50%;
  box-shadow:0 0 30px 8px rgba(255,255,120,.25), inset 0 0 40px rgba(255,255,255,.08);
  animation:thunder 0.12s linear infinite;
  pointer-events:none;
}
@keyframes thunder{
  0%{filter:brightness(1)}
  50%{filter:brightness(2)}
  100%{filter:brightness(1)}
}

/* small countdown badge */
.effect-badge{position:absolute;top:8px;right:8px;background:rgba(0,0,0,.4);padding:6px 8px;border-radius:10px;font-size:12px;border:1px solid rgba(255,255,255,.06);}
/* toast */
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:80px;background:#111;padding:10px 14px;border-radius:8px;color:#fff;box-shadow:0 6px 20px rgba(0,0,0,.6);display:none;z-index:300;}
</style>
</head>

<body>

<div class="top">
  <div class="wallet">üîó Connect Wallet</div>
  <div class="balance">NJR <span id="points">1525</span></div>
</div>

<div class="center">
  <div class="coin" id="coin">
    <img src="logo.png" alt="NJR">
    <div class="effect-badge" id="effectBadge" style="display:none"></div>
  </div>

  <div class="energy-boost">
    <div class="box">‚ö° <span id="energy">474</span> / <span id="maxEnergy">500</span></div>
    <div class="box boost" id="openBoostBtn">üî• Boost</div>
  </div>
</div>

<div class="bottom">
  <div class="nav active">üí∞<div>Earn</div></div>
  <div class="nav">‚úÖ<div>Tasks</div></div>
  <div class="nav">üë§<div>Account</div></div>
  <div class="nav">üí≥<div>Cashier</div></div>
</div>

<!-- MODAL -->
<div class="modal-backdrop" id="modalBackdrop">
  <div class="modal" role="dialog" aria-modal="true">
    <h3>Boosts & Purchases</h3>
    <div class="small">Your daily boosters: <span id="dailyInfo">‚Äî</span></div>

    <div style="margin-top:12px;">
      <div style="display:flex;gap:8px;">
        <div class="booster-btn" id="btnFullTank" role="button" aria-pressed="false" tabindex="0">
          <div style="font-weight:800">‚ö° Full Tank</div>
          <div class="small">Refills energy instantly (3/day)</div>
        </div>
        <div class="booster-btn" id="btnTaping" role="button" aria-pressed="false" tabindex="0">
          <div style="font-weight:800">üî• Taping Guru</div>
          <div class="small">Tap multiplier √ó2 for 10 seconds (3/day)</div>
        </div>
      </div>

      <div style="margin-top:14px;">
        <div style="font-weight:700;margin-bottom:6px;">Boost √ó2 (Buy duration)</div>
        <div class="purchase-options">
          <div class="option" data-price="0.5" data-duration="3600"><div>√ó2 ‚Äî 1 hour</div><div>$0.5</div></div>
          <div class="option" data-price="1" data-duration="14400"><div>√ó2 ‚Äî 4 hours</div><div>$1</div></div>
          <div class="option" data-price="4" data-duration="28800"><div>√ó2 ‚Äî 8 hours</div><div>$4</div></div>
        </div>
      </div>

      <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end;">
        <button class="btn ghost" id="closeModal">Cancel</button>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
const tg = window.Telegram.WebApp;
tg.ready();

const userId = tg.initDataUnsafe?.user?.id || "guest";
let energy=0, maxEnergy=500, points=0, boost=1;
let displayedEnergy=0, displayedPoints=0;
let pendingGain=0;
let initialLoaded=false;

// activeEffects from server: {type:"taping"|"x2", expires_at: timestamp (ms)}
let activeEffects = [];
let localMultiplier = 1; // used for client immediate tap multiplier

// helper: toast
function showToast(msg, timeout=2000){
  const t = document.getElementById("toast");
  t.innerText = msg;
  t.style.display = "block";
  clearTimeout(t._to);
  t._to = setTimeout(()=> t.style.display = "none", timeout);
}

// animate number (same helper as ŸÇÿ®ŸÑ)
function animateNumber(from,to,onStep,duration=400){
  if(from===to){ onStep(to); return Promise.resolve(); }
  return new Promise(resolve=>{
    const start = performance.now();
    const sign = to>from?1:-1;
    const range = Math.abs(to-from);
    function step(now){
      const t = Math.min(1,(now-start)/duration);
      const eased = 1 - Math.pow(1 - t, 2);
      const current = from + sign * Math.round(range * eased);
      onStep(current);
      if(t<1) requestAnimationFrame(step);
      else { onStep(to); resolve(); }
    }
    requestAnimationFrame(step);
  });
}

function updateUI(){
  document.getElementById("energy").innerText = Math.max(0, Math.floor(displayedEnergy));
  document.getElementById("maxEnergy").innerText = maxEnergy;
  document.getElementById("points").innerText = Math.floor(displayedPoints);
  // update effect badge
  const badge = document.getElementById("effectBadge");
  const now = Date.now();
  const active = activeEffects.find(e=> e.expires_at > now);
  if(active){
    const rem = Math.ceil((active.expires_at - now)/1000);
    badge.innerText = `${active.type === 'taping' ? '√ó2 (T)' : '√ó2 (B)'} ${rem}s`;
    badge.style.display = "block";
    document.getElementById("coin").classList.add("lightning");
  } else {
    badge.style.display = "none";
    document.getElementById("coin").classList.remove("lightning");
  }
}

// ====== state polling (keeps server authoritative values & active effects) ======
let pollInterval = 2000; let pollTimer=null;
async function fetchStateOnce(){
  try{
    const r = await fetch(`/state/${userId}`);
    return await r.json();
  }catch(e){ console.warn("state fetch failed",e); return null; }
}

async function pollState(){
  const data = await fetchStateOnce();
  if(!data || !data.success) return;
  // update server authoritative
  const prevPoints = points;
  energy = data.energy; maxEnergy = data.maxEnergy; points = data.points;
  // active effects list from server (array of {type,expires_at})
  activeEffects = (data.active_effects || []).map(e=> ({...e, expires_at: e.expires_at}));
  // reduce pendingGain by confirmed increment
  const confirmedGain = Math.max(0, points - prevPoints);
  pendingGain = Math.max(0, pendingGain - confirmedGain);
  // reconcile
  const targetDisplayedPoints = points + pendingGain;
  if(!initialLoaded){
    displayedEnergy = energy; displayedPoints = targetDisplayedPoints; initialLoaded=true; updateUI();
  } else {
    animateNumber(displayedEnergy, energy, v=>{ displayedEnergy = v; updateUI(); }, 300);
    animateNumber(displayedPoints, targetDisplayedPoints, v=>{ displayedPoints = v; updateUI(); }, 300);
  }
  // set local multiplier based on activeEffects
  const now = Date.now();
  const tapEffect = activeEffects.find(e=> e.type === 'taping' && e.expires_at > now);
  const x2Effect = activeEffects.find(e=> e.type === 'x2' && e.expires_at > now);
  localMultiplier = (tapEffect || x2Effect) ? 2 : 1;
}

function startPolling(){
  if(pollTimer) return;
  pollState();
  pollTimer = setInterval(pollState, pollInterval);
  document.addEventListener('visibilitychange', ()=>{
    if(document.hidden){ clearInterval(pollTimer); pollTimer=null; }
    else startPolling();
  });
}
startPolling();

// send heartbeat to mark daily/online activity
async function sendHeartbeat() {
  if (!userId || String(userId) === 'guest') return;
  try {
    await fetch(`/heartbeat/${userId}`, { method: 'POST' });
  } catch (e) {
    console.warn('heartbeat failed', e);
  }
}

// call heartbeat once on load
sendHeartbeat();

// ====== Boost modal UI handling ======
const modalBackdrop = document.getElementById("modalBackdrop");
document.getElementById("openBoostBtn").addEventListener("click", ()=> {
  // show daily info (server-limited counts)
  fetch(`/daily-info/${userId}`).then(r=>r.json()).then(d=>{
    if(d?.success){
      document.getElementById("dailyInfo").innerText = `Taping ${d.taping_used}/3 ¬∑ FullTank ${d.fulltank_used}/3`;
    } else {
      document.getElementById("dailyInfo").innerText = '‚Äî';
    }
    modalBackdrop.style.display = "flex";
  }).catch(()=>{ modalBackdrop.style.display="flex"; });
});
document.getElementById("closeModal").addEventListener("click", ()=> modalBackdrop.style.display="none");

// Full Tank
document.getElementById("btnFullTank").addEventListener("click", async ()=>{
  showToast("ÿ∑ŸÑÿ® Full Tank...");
  try {
    const res = await fetch("/boost/full", {method:"POST",headers:{"Content-Type":"application/json"}, body: JSON.stringify({user_id:userId})});
    const data = await res.json();
    if(!data.success){ showToast(data.message || "Activation failed"); return; }
    // server returns new energy
    energy = data.energy; points = data.points || points;
    // reconcile display
    pendingGain = 0;
    animateNumber(displayedEnergy, energy, v=>{ displayedEnergy=v; updateUI(); }, 300);
    animateNumber(displayedPoints, points, v=>{ displayedPoints=v; updateUI(); }, 300);
    // Close modal immediately so user can continue
    modalBackdrop.style.display = "none";
    showToast("Energy refilled");
  } catch (err) {
    console.warn("Full Tank activation error", err);
    showToast("Activation failed");
  }
});

// Taping Guru (10s √ó2)
document.getElementById("btnTaping").addEventListener("click", async ()=>{
  showToast("Activation Taping Guru...");
  try {
    const res = await fetch("/boost/taping", {method:"POST",headers:{"Content-Type":"application/json"}, body: JSON.stringify({user_id:userId})});
    const data = await res.json();
    if(!data.success){ showToast(data.message || "Activation failed"); return; }
    // server returns effect with expires_at
    activeEffects = data.active_effects || activeEffects;
    // update local multiplier and UI immediately
    localMultiplier = 2;
    updateUI();
    // Close modal so user can immediately benefit from the 10s window
    modalBackdrop.style.display = "none";
    showToast("Taping Guru activated for 10 seconds");
  } catch (err) {
    console.warn("Taping activation error", err);
    showToast("Activation failed");
  }
});

// Purchase options
document.querySelectorAll('.purchase-options .option').forEach(opt=>{
  opt.addEventListener('click', async ()=> {
    const price = parseFloat(opt.dataset.price);
    const duration = parseInt(opt.dataset.duration,10);
    // create purchase on server, server will create invoice via Telegram / provider and return payment_url or purchase_id
    showToast("Creating invoice...");
    const r = await fetch("/purchase", {method:"POST",headers:{"Content-Type":"application/json"}, body: JSON.stringify({ user_id: userId, price, duration })});
    const j = await r.json();
    if(!j.success){ showToast(j.message || "Invoice creation error"); return; }
    // j.payment_url or j.purchase_id provided
    if(j.payment_url){
      // open payment url (user completes via Telegram wallet or payment page)
      window.open(j.payment_url, "_blank");
    }
    // poll status until confirmed or timeout
    showToast("Waiting for payment confirmation...");
    const purchaseId = j.purchase_id;
    const start = Date.now();
    const timeout = 2*60*1000; // 2 minutes
    const poll = setInterval(async ()=>{
      const sres = await fetch(`/purchase/status/${purchaseId}`);
      const sj = await sres.json();
      if(sj.success && sj.status === 'paid'){
        clearInterval(poll);
        showToast("Payment confirmed. √ó2 activated instantly");
        // server should have added an active_effect of type 'x2'
        await pollState(); // force refresh
        modalBackdrop.style.display = "none";
      } else if(Date.now() - start > timeout){
        clearInterval(poll);
        showToast("Payment time expired or the user did not complete the payment");
      }
    }, 2000);
  });
});

// ====== TAP logic (uses localMultiplier) ======
const coin = document.getElementById("coin");
coin.addEventListener("click", ()=>{
  if(Math.floor(displayedEnergy) <= 0) return;
  // visual + float
  const p = document.createElement("div");
  p.className = "plus";
  p.innerText = `+${boost * localMultiplier}`;
  const r = coin.getBoundingClientRect();
  p.style.left = (r.left + r.width/2) + "px";
  p.style.top = (r.top + r.height/2) + "px";
  document.body.appendChild(p);
  setTimeout(()=>p.remove(),900);
  if(navigator.vibrate) navigator.vibrate(20);

  // optimistic UI
  displayedEnergy = Math.max(0, displayedEnergy - 1);
  pendingGain += (boost * localMultiplier);
  displayedPoints = points + pendingGain;
  updateUI();

  // send tap to server (server will check active effects and reply gain & new energy)
  fetch("/tap", {method:"POST",headers:{"Content-Type":"application/json"},body: JSON.stringify({user_id:userId})})
    .then(r=>r.json())
    .then(data=>{
      if(!data.success){
        // rollback by fetching state
        pollState();
        return;
      }
      // server confirms: update authoritative
      energy = data.energy;
      points += data.gain;
      pendingGain = Math.max(0, pendingGain - data.gain);
      // reconcile displays
      animateNumber(displayedEnergy, energy, v=>{ displayedEnergy=v; updateUI(); }, 300);
      animateNumber(displayedPoints, points + pendingGain, v=>{ displayedPoints=v; updateUI(); }, 300);
    }).catch(err=>{
      console.warn("tap error",err);
      // on error refresh
      pollState();
    });
});

// start
updateUI();
</script>

<!-- APPEND: Account panel (paste this before the closing </body>) -->
<style>
/* Account panel styles (scoped) */
.account-panel-backdrop{
  position:fixed;inset:0;display:none;align-items:flex-start;justify-content:center;
  padding-top:40px;z-index:400;background:linear-gradient(180deg,rgba(6,6,7,.45),rgba(6,6,7,.7));
  backdrop-filter: blur(6px);
}
.account-panel{
  width:92%;max-width:520px;margin:0 auto;background:linear-gradient(180deg,#241d2b,#2d2436);
  border-radius:14px;padding:14px 14px 20px;color:#fff;box-shadow:0 12px 40px rgba(0,0,0,.6);
  border:1px solid rgba(255,255,255,.03);
  font-family: 'Poppins', system-ui;
}
.account-top-tabs{display:flex;gap:8px;background:rgba(255,255,255,.02);padding:8px;border-radius:12px;align-items:center;justify-content:center;margin-bottom:12px;}
.account-tab-btn{flex:1;padding:8px 12px;border-radius:10px;text-align:center;color:#cfc1e8;font-weight:600;cursor:pointer;border:1px solid transparent;}
.account-tab-btn.active{background:linear-gradient(180deg,#3a2f48,#442f53);color:#fff;border:1px solid rgba(255,255,255,.04);box-shadow:0 6px 18px rgba(0,0,0,.45);}
.account-section{padding:8px 6px;min-height:220px;}
.account-stats{display:flex;flex-direction:column;gap:18px;align-items:center;padding-top:6px;}
.stat-row{text-align:center;}
.stat-title{color:#bfb1d8;font-size:13px;margin-bottom:6px;}
.stat-value{font-weight:800;font-size:22px;letter-spacing:2px;color:#fff;text-shadow:0 6px 18px rgba(0,0,0,.6);}
.invite-card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01));padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.03);display:flex;gap:12px;align-items:center;justify-content:space-between;}
.invite-left{flex:1;color:#e6dff6;}
.invite-label{font-weight:700;margin-bottom:6px;color:#fff;}
.invite-link{font-size:13px;color:#cfc1e8;word-break:break-all;opacity:.95;}
.copy-btn{background:#6f4bd8;color:#fff;padding:8px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:700;}
.ref-list{margin-top:12px;padding-top:6px;color:#d9cfe9;}
.settings-list{display:flex;flex-direction:column;gap:10px;}
.settings-item{background:rgba(255,255,255,.02);padding:12px;border-radius:10px;display:flex;justify-content:space-between;align-items:center;cursor:pointer;border:1px solid rgba(255,255,255,.02);}
/* small tweaks */
.close-panel{position:absolute;right:18px;top:12px;color:#cfc1e8;cursor:pointer;font-weight:700;}
.no-ref{padding:24px 6px;text-align:center;color:#d6cfe6;}
.account-small{font-size:13px;color:#bfb1d8;margin-bottom:6px;}
@media (min-width:720px){ .account-panel{margin-top:48px;} }
</style>

<div class="account-panel-backdrop" id="accountPanelBackdrop" aria-hidden="true">
  <div class="account-panel" role="dialog" aria-modal="true" aria-labelledby="accountTitle">
    <div style="position:relative;">
      <div id="accountTitle" style="font-weight:800;font-size:16px;color:#fff;margin-bottom:8px;">Account</div>
      <div class="close-panel" id="closeAccountPanel" role="button" tabindex="0">‚úï</div>
    </div>

    <div class="account-top-tabs" role="tablist" aria-label="Account tabs">
      <div class="account-tab-btn" data-tab="ref">Ref</div>
      <div class="account-tab-btn active" data-tab="stats">Stats</div>
      <div class="account-tab-btn" data-tab="settings">Settings</div>
    </div>

    <div class="account-section" id="accountSection">
      <!-- STATS (default active) -->
      <div class="account-content" data-content="stats" style="display:block;">
        <div class="account-stats">
          <div class="stat-row">
            <div class="stat-title">Total Share Balance:</div>
            <div class="stat-value" id="statShare">‚Äî</div>
          </div>
          <div class="stat-row">
            <div class="stat-title">Total Touches:</div>
            <div class="stat-value" id="statTouches">‚Äî</div>
          </div>
          <div class="stat-row">
            <div class="stat-title">Total Players:</div>
            <div class="stat-value" id="statPlayers">‚Äî</div>
          </div>
          <div class="stat-row">
            <div class="stat-title">Daily Users:</div>
            <div class="stat-value" id="statDaily">‚Äî</div>
          </div>
          <div class="stat-row">
            <div class="stat-title">Online Players:</div>
            <div class="stat-value" id="statOnline">‚Äî</div>
          </div>
        </div>
      </div>

      <!-- REF -->
      <div class="account-content" data-content="ref" style="display:none;">
        <div class="account-small">My ref bonus: <span id="myRefBonus">0</span></div>
        <div class="account-small">My ref: <span id="myRefCount">0</span></div>

        <div class="invite-card" style="margin-top:8px;">
          <div class="invite-left">
            <div class="invite-label">My invite link:</div>
            <div class="invite-link" id="inviteLink">‚Äî</div>
          </div>
          <div>
            <button class="copy-btn" id="copyInviteBtn">Copy</button>
          </div>
        </div>

        <div class="ref-list">
          <div style="font-weight:800;margin-top:12px;">My Referals list:</div>
          <div class="no-ref" id="noRefText">You don't have referrals üò≠</div>
          <div id="refListContainer" style="display:none;"></div>
        </div>
      </div>

      <!-- SETTINGS -->
      <div class="account-content" data-content="settings" style="display:none;">
        <div class="settings-list">
          <div class="settings-item" role="button" id="privacyBtn">Privacy Policy <span>‚Ä∫</span></div>
          <div class="settings-item" role="button" id="termsBtn">Terms of Use <span>‚Ä∫</span></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* Account panel behavior (uses existing userId variable from your script) */
(function(){
  const backdrop = document.getElementById('accountPanelBackdrop');
  const closeBtn = document.getElementById('closeAccountPanel');
  const tabs = document.querySelectorAll('.account-tab-btn');
  const contents = document.querySelectorAll('.account-content');

  // refs in DOM
  const myRefCountEl = document.getElementById('myRefCount');
  const myRefBonusEl = document.getElementById('myRefBonus');
  const refListContainer = document.getElementById('refListContainer');
  const noRefText = document.getElementById('noRefText');

  // open when pressing the Account nav (third .nav)
  const accountNav = document.querySelector('.bottom .nav:nth-child(3)');
  if(accountNav){
    accountNav.addEventListener('click', ()=> openAccountPanel());
  }

  async function openAccountPanel(){
    // send heartbeat to mark user active (daily/online)
    try { if (typeof userId !== 'undefined' && String(userId) !== 'guest') await fetch(`/heartbeat/${userId}`, { method: 'POST' }); } catch(e){}

    // fill invite link using userId (existing var in page)
    const inviteEl = document.getElementById('inviteLink');
    try{
      const botUsername = 'NJROfficialBot';
      const uid = (typeof userId !== 'undefined') ? userId : 'guest';
      const link = `https://t.me/${botUsername}?start=r_${uid}`;
      inviteEl.innerText = link;
      inviteEl.setAttribute('data-link', link);
    }catch(e){
      inviteEl.innerText = 'https://t.me/YOUR-BOT?start=r_XXXXX';
    }

    // fetch global stats and show them
    try {
      const gres = await fetch('/global-stats');
      const g = await gres.json();
      if (g && g.success) {
        document.getElementById('statShare').innerText = (g.total_share_balance || 0).toLocaleString();
        document.getElementById('statTouches').innerText = (g.total_touches || 0).toLocaleString();
        document.getElementById('statPlayers').innerText = (g.total_players || 0).toLocaleString();
        document.getElementById('statDaily').innerText = (g.daily_users || 0).toLocaleString();
        document.getElementById('statOnline').innerText = (g.online_players || 0).toLocaleString();
      } else {
        // fallback to previous hardcoded values
        document.getElementById('statShare').innerText = '9710702162713';
        document.getElementById('statTouches').innerText = '106 056 491 953';
        document.getElementById('statPlayers').innerText = '74 839 124';
        document.getElementById('statDaily').innerText = '22 010';
        document.getElementById('statOnline').innerText = '318';
      }
    } catch (err) {
      console.warn('global-stats fetch failed', err);
      document.getElementById('statShare').innerText = '9710702162713';
      document.getElementById('statTouches').innerText = '106 056 491 953';
      document.getElementById('statPlayers').innerText = '74 839 124';
      document.getElementById('statDaily').innerText = '22 010';
      document.getElementById('statOnline').innerText = '318';
    }

    // fetch referral info from server and populate UI
    try {
      if (typeof userId !== 'undefined' && userId && String(userId) !== 'guest') {
        const res = await fetch(`/ref/${userId}`);
        const j = await res.json();
        if (j && j.success) {
          myRefCountEl.innerText = j.referrals_count || 0;
          // use stored referral bonus total from server (not computed client-side)
          myRefBonusEl.innerText = j.ref_bonus_total || 0;

          // populate list
          if (Array.isArray(j.referrals) && j.referrals.length > 0) {
            refListContainer.innerHTML = ''; refListContainer.style.display = 'block'; noRefText.style.display = 'none';
            j.referrals.forEach(r => {
              const item = document.createElement('div');
              item.style.padding = '8px 6px';
              item.style.borderBottom = '1px solid rgba(255,255,255,.02)';
              item.style.display = 'flex';
              item.style.justifyContent = 'space-between';
              item.style.alignItems = 'center';
              const left = document.createElement('div');
              left.style.fontWeight = '700';
              left.style.color = '#fff';
              left.innerText = r.uid;
              const right = document.createElement('div');
              right.style.fontSize = '12px';
              right.style.color = '#cfc1e8';
              right.innerText = r.at ? new Date(r.at).toLocaleString() : '';
              item.appendChild(left);
              item.appendChild(right);
              refListContainer.appendChild(item);
            });
          } else {
            refListContainer.style.display = 'none';
            noRefText.style.display = 'block';
          }
        } else {
          // failed to get referral info
          myRefCountEl.innerText = '0';
          myRefBonusEl.innerText = '0';
          refListContainer.style.display = 'none';
          noRefText.style.display = 'block';
        }
      } else {
        // guest - cannot fetch
        myRefCountEl.innerText = '0';
        myRefBonusEl.innerText = '0';
        refListContainer.style.display = 'none';
        noRefText.style.display = 'block';
      }
    } catch (err) {
      console.warn("Failed to fetch ref info", err);
      myRefCountEl.innerText = '0';
      myRefBonusEl.innerText = '0';
      refListContainer.style.display = 'none';
      noRefText.style.display = 'block';
    }

    backdrop.style.display = 'flex';
    backdrop.setAttribute('aria-hidden','false');
  }

  function closePanel(){
    backdrop.style.display = 'none';
    backdrop.setAttribute('aria-hidden','true');
  }

  closeBtn.addEventListener('click', closePanel);
  backdrop.addEventListener('click', (e)=>{ if(e.target === backdrop) closePanel(); });

  // tab switching
  tabs.forEach(t=>{
    t.addEventListener('click', ()=>{
      tabs.forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      const target = t.getAttribute('data-tab');
      contents.forEach(c=>{
        if(c.getAttribute('data-content') === target) c.style.display = 'block';
        else c.style.display = 'none';
      });
    });
  });

  // copy invite
  const copyBtn = document.getElementById('copyInviteBtn');
  copyBtn.addEventListener('click', async ()=>{
    const link = document.getElementById('inviteLink').getAttribute('data-link') || document.getElementById('inviteLink').innerText;
    try{
      await navigator.clipboard.writeText(link);
      // small toast reuse if present
      if(typeof showToast === 'function') showToast('Invite link copied');
      else alert('Invite link copied');
    }catch(e){
      if(typeof showToast === 'function') showToast('Copy failed');
      else alert('Copy failed');
    }
  });

  // settings items (open external pages or show toast)
  document.getElementById('privacyBtn').addEventListener('click', ()=>{ 
    if(typeof showToast === 'function') showToast('Open Privacy Policy');
    const evt = new Event('openPrivacy');
    document.dispatchEvent(evt);
  });
  document.getElementById('termsBtn').addEventListener('click', ()=>{ 
    if(typeof showToast === 'function') showToast('Open Terms of Use');
    const evt = new Event('openTerms');
    document.dispatchEvent(evt);
  });
})();
</script>
<!-- END APPEND -->

<!-- APPEND: Privacy & Terms viewer (paste this before the closing </body>) -->
<style>
/* Policy modal (scoped) */
.policy-backdrop{
  position:fixed;inset:0;display:none;align-items:center;justify-content:center;
  background:rgba(0,0,0,.6);z-index:700;padding:20px;backdrop-filter:blur(6px);
}
.policy-modal{
  width:92%;max-width:760px;max-height:86vh;overflow:auto;background:linear-gradient(180deg,#1f1826,#2a2237);
  border-radius:12px;padding:18px 18px 22px;color:#fff;box-shadow:0 12px 40px rgba(0,0,0,.6);
  border:1px solid rgba(255,255,255,.03);font-family:'Poppins',system-ui;
}
.policy-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;}
.policy-title{font-weight:800;font-size:18px;color:#fff;}
.policy-close{background:transparent;border:1px solid rgba(255,255,255,.04);color:#cfc1e8;padding:6px 10px;border-radius:8px;cursor:pointer;}
.policy-content{font-size:14px;line-height:1.6;color:#e6dff6;}
.policy-section{margin-top:10px;margin-bottom:10px;}
.policy-small{font-size:13px;color:#bfb1d8;margin-top:8px;}
.policy-content p{margin:8px 0;}
</style>

<div class="policy-backdrop" id="policyBackdrop" aria-hidden="true">
  <div class="policy-modal" role="dialog" aria-modal="true" aria-labelledby="policyTitle">
    <div class="policy-header">
      <div id="policyTitle" class="policy-title">Policy</div>
      <button class="policy-close" id="closePolicyBtn">ÿ•ÿ∫ŸÑÿßŸÇ</button>
    </div>
    <div class="policy-content" id="policyContent" tabindex="0"></div>
  </div>
</div>

<script>
// Policy viewer behavior
(function(){
  const backdrop = document.getElementById('policyBackdrop');
  const contentEl = document.getElementById('policyContent');
  const titleEl = document.getElementById('policyTitle');
  const closeBtn = document.getElementById('closePolicyBtn');

  // Texts provided (Privacy Policy & Terms of Use) - full HTML content
  const PRIVACY_HTML = `
  <h3>Privacy Policy for NJR (Nova Joint Reserve)</h3>
  <div class="policy-small">Last Updated: 18 January 2026</div>
  <div class="policy-section">
    <p>Welcome to NJR (Nova Joint Reserve). Your privacy is important to us. This Privacy Policy explains how we collect, use, disclose, and protect your information when you use our Telegram mini-app NJR (‚Äúwe‚Äù, ‚Äúour‚Äù, or ‚Äúus‚Äù).</p>

    <h4>1. Information We Collect</h4>
    <h5>1.1 Personal Information</h5>
    <p>We may collect limited personal information necessary to operate the NJR mini-app, including:</p>
    <ul>
      <li><strong>Telegram Username:</strong> Used to identify and interact with you within the app.</li>
      <li><strong>Contact Information:</strong> Such as email address or phone number, only if you voluntarily provide it for support or feedback purposes.</li>
      <li><strong>Profile Information:</strong> Public Telegram profile information that is accessible to us through the Telegram platform.</li>
    </ul>

    <h5>1.2 Non-Personal Information</h5>
    <p>We may collect non-personal data that does not directly identify you, including:</p>
    <ul>
      <li><strong>Usage Data:</strong> Information about how you interact with the app, such as taps, features used, timestamps, and activity statistics.</li>
      <li><strong>Device Information:</strong> Basic technical information such as device type, operating system version, and anonymized identifiers.</li>
    </ul>
  </div>

  <div class="policy-section">
    <h4>2. How We Use Your Information</h4>
    <p>We use the collected information for the following purposes:</p>
    <ul>
      <li><strong>Providing and Maintaining the Service:</strong> To operate, maintain, and deliver NJR functionalities.</li>
      <li><strong>Improving the Service:</strong> To analyze usage patterns and improve performance, features, and user experience.</li>
      <li><strong>Communication:</strong> To respond to inquiries, provide support, and send important service-related notifications.</li>
      <li><strong>Security and Fraud Prevention:</strong> To detect, prevent, and address technical issues, abuse, or unauthorized activity.</li>
    </ul>
  </div>

  <div class="policy-section">
    <h4>3. Information Sharing and Disclosure</h4>
    <p>We do not sell, trade, or rent your personal information. We may share information only in the following situations:</p>
    <ul>
      <li><strong>With Your Consent:</strong> When you explicitly agree to share information.</li>
      <li><strong>Service Providers:</strong> Trusted third parties that help operate NJR (such as hosting or analytics services). These providers may access data only to perform tasks on our behalf and are bound by confidentiality obligations.</li>
      <li><strong>Legal Obligations:</strong> When required by law, regulation, court order, or governmental request.</li>
    </ul>
  </div>

  <div class="policy-section">
    <h4>4. Data Security</h4>
    <p>We implement reasonable technical and organizational security measures to protect your information from unauthorized access, alteration, disclosure, or destruction.
    However, no method of transmission over the internet or electronic storage is completely secure, and we cannot guarantee absolute security.</p>
  </div>

  <div class="policy-section">
    <h4>5. Your Rights</h4>
    <p>Depending on applicable laws, you may have the right to:</p>
    <ul>
      <li>Access and Update your personal information.</li>
      <li>Request Deletion of your personal data, subject to legal or operational requirements.</li>
      <li>Object or Restrict Processing of your data under certain conditions.</li>
      <li>Withdraw Consent at any time where processing is based on your consent.</li>
    </ul>
    <p>To exercise these rights, please contact us at: <strong>support@njr.ai</strong></p>
  </div>

  <div class="policy-section">
    <h4>6. Children‚Äôs Privacy</h4>
    <p>NJR is not intended for children under the age of 13. We do not knowingly collect personal information from children under 13.
    If we become aware that such data has been collected, we will take steps to delete it promptly.</p>
  </div>

  <div class="policy-section">
    <h4>7. Changes to This Privacy Policy</h4>
    <p>We may update this Privacy Policy from time to time. Any changes will be posted within the app or on this page with an updated ‚ÄúLast Updated‚Äù date.
    You are encouraged to review this Privacy Policy periodically.</p>
  </div>

  <div class="policy-section">
    <h4>8. Contact Us</h4>
    <p>If you have any questions or concerns regarding this Privacy Policy, please contact us at: <strong>support@njr.ai</strong></p>
    <p>We aim to respond as soon as possible, and no later than 30 days.</p>
  </div>
  `;

  const TERMS_HTML = `
  <h3>Terms of Use ‚Äî NJR (Nova Joint Reserve)</h3>
  <div class="policy-small">Effective Date: 18 January 2026</div>

  <div class="policy-section">
    <h4>1. Acceptance of Terms</h4>
    <p>By accessing or using NJR (Nova Joint Reserve) (‚ÄúNJR‚Äù, ‚ÄúService‚Äù, ‚Äúwe‚Äù, ‚Äúour‚Äù, or ‚Äúus‚Äù), you confirm that you have read, fully understood, and agreed to be legally bound by these Terms of Use, our Privacy Policy, and any applicable Telegram Mini App Terms of Service.</p>
    <p>These Terms may be updated or modified from time to time without prior notice. Your continued use of NJR constitutes acceptance of any revised Terms.</p>
  </div>

  <div class="policy-section">
    <h4>2. In-App Purchases</h4>
    <p>All in-app purchases, including boosts, upgrades, or virtual items, are provided solely for entertainment and engagement purposes.</p>
    <p>Such purchases do not constitute investments, have no guaranteed financial value, and do not represent ownership, securities, or profit rights.</p>
    <p>All purchases are made voluntarily, and users are solely responsible for their decisions. NJR assumes no liability for any outcomes, financial or otherwise, resulting from in-app purchases. All sales are final and non-refundable, except where required by applicable law. Users should carefully consider their financial situation before making any purchase.</p>
  </div>

  <div class="policy-section">
    <h4>3. Payment-Related Disputes</h4>
    <p>Payments initiated through NJR, whether in cryptocurrency or fiat, are processed by third-party payment providers. NJR does not handle, manage, verify, or guarantee these transactions.</p>
    <p>Any disputes, claims, errors, losses, delays, or technical issues related to payments must be addressed directly with the relevant payment provider. NJR shall not be liable for any losses or damages arising from payment-related issues and will not participate in related disputes.</p>
  </div>

  <div class="policy-section">
    <h4>4. Disclaimer</h4>
    <p><strong>General Disclaimer:</strong> NJR is provided on an ‚ÄúAS IS‚Äù and ‚ÄúAS AVAILABLE‚Äù basis. You use the Service at your own risk.</p>
    <p><strong>No Performance Warranty:</strong> We do not guarantee uninterrupted, secure, or error-free operation, nor any specific outcomes or results.</p>
    <p><strong>Technical Disclaimer:</strong> NJR is not responsible for technical failures including blockchain issues, server downtime, software bugs, or connectivity problems.</p>
    <p><strong>User Conduct:</strong> NJR is not responsible for the actions, behavior, or content of users.</p>
    <p><strong>Third-Party Services:</strong> NJR may link to or integrate third-party services. We do not control or endorse them and are not responsible for their content, policies, or practices.</p>
  </div>

  <div class="policy-section">
    <h4>5. Limitation of Liability</h4>
    <p>To the maximum extent permitted by law, NJR (Nova Joint Reserve) shall not be liable for any indirect, incidental, special, consequential, or punitive damages, including but not limited to loss of profits, data, goodwill, or virtual assets, arising from:</p>
    <ul>
      <li>Use or inability to use the Service</li>
      <li>Unauthorized access to data or accounts</li>
      <li>Third-party conduct or services</li>
      <li>Errors, interruptions, or security breaches</li>
    </ul>
  </div>

  <div class="policy-section">
    <h4>6. Intellectual Property</h4>
    <p>All content, features, software, designs, logos, text, graphics, and functionality related to NJR are the exclusive property of Nova Joint Reserve or its licensors and are protected by international intellectual property laws.</p>
    <p>You may not copy, modify, distribute, sell, reverse-engineer, or exploit any part of the Service without prior written consent. Unauthorized use of NJR intellectual property is strictly prohibited and may result in legal action.</p>
  </div>

  <div class="policy-section">
    <h4>7. Privacy</h4>
    <p>Your use of NJR is subject to our Privacy Policy, which explains how we collect, use, and protect your personal information. By using the Service, you consent to such processing.</p>
  </div>

  <div class="policy-section">
    <h4>8. Termination</h4>
    <p>We reserve the right to suspend or terminate your access to NJR at any time, with or without notice, for any reason, including violation of these Terms.
    Upon termination, your right to use the Service will immediately cease. Provisions that by their nature should survive termination shall remain in effect.</p>
  </div>

  <div class="policy-section">
    <h4>9. Indemnification</h4>
    <p>You agree to indemnify and hold harmless NJR (Nova Joint Reserve), its affiliates, officers, directors, employees, and agents from any claims, damages, losses, liabilities, or expenses (including legal fees) arising from your use of the Service or violation of these Terms.</p>
  </div>

  <div class="policy-section">
    <h4>10. Governing Law</h4>
    <p>These Terms shall be governed by and construed in accordance with the laws of Seychelles, without regard to conflict of law principles.</p>
  </div>

  <div class="policy-section">
    <h4>11. Changes to Terms</h4>
    <p>We reserve the right to modify or replace these Terms at any time. If changes are material, we will provide reasonable notice (where feasible). Continued use of the Service after changes become effective constitutes acceptance of the updated Terms.</p>
  </div>

  <div class="policy-section">
    <h4>12. Binding Telegram Terms</h4>
    <p>By using NJR, you also agree to be bound by the Telegram Mini App Terms of Use, as provided by Telegram.</p>
  </div>

  <div class="policy-section">
    <h4>13. Contact Us</h4>
    <p>If you have any questions regarding these Terms of Use, please contact us at: <strong>support@njr.ai</strong></p>
  </div>
  `;

  function openPolicy(title, html){
    titleEl.innerText = title;
    contentEl.innerHTML = html;
    backdrop.style.display = 'flex';
    backdrop.setAttribute('aria-hidden','false');
    contentEl.focus();
  }

  function closePolicy(){
    backdrop.style.display = 'none';
    backdrop.setAttribute('aria-hidden','true');
    contentEl.innerHTML = '';
  }

  const privacyBtn = document.getElementById('privacyBtn');
  const termsBtn = document.getElementById('termsBtn');

  if(privacyBtn){
    privacyBtn.addEventListener('click', ()=> {
      openPolicy('Privacy Policy ‚Äî NJR', PRIVACY_HTML);
    });
  }
  if(termsBtn){
    termsBtn.addEventListener('click', ()=> {
      openPolicy('Terms of Use ‚Äî NJR', TERMS_HTML);
    });
  }

  closeBtn.addEventListener('click', closePolicy);
  backdrop.addEventListener('click', (e)=>{ if(e.target === backdrop) closePolicy(); });

  document.addEventListener('keydown', (e)=>{
    if(e.key === 'Escape' && backdrop.style.display === 'flex') closePolicy();
  });

  // also listen to custom events from Account panel to open policies
  document.addEventListener('openPrivacy', ()=> openPolicy('Privacy Policy ‚Äî NJR', PRIVACY_HTML));
  document.addEventListener('openTerms', ()=> openPolicy('Terms of Use ‚Äî NJR', TERMS_HTML));
})();
</script>
<!-- END APPEND -->

</body>
</html>
