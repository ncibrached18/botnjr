<!doctype html>
<html lang="ar">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>NJR</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

<style>
/* ŸÜŸÅÿ≥ CSS ÿßŸÑÿ£ÿµŸÑŸä ŸÖÿπ ÿ•ÿ∂ÿßŸÅÿßÿ™ ŸÑŸÑŸÖŸàÿØÿßŸÑ ŸàÿßŸÑŸàŸÖŸäÿ∂ Ÿàÿ™ÿ≠ÿ≥ŸäŸÜ ÿßŸÑÿ¥ŸÉŸÑ ÿ≠ÿ≥ÿ® ÿßŸÑÿµŸàÿ± */
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color: transparent;}
html,body{width:100%;height:100%;overflow:hidden;font-family:'Poppins',system-ui;background: radial-gradient(circle at top,#2e2440,#1a1426);color:#fff;}
.top{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;}
.wallet{background:rgba(255,255,255,.08);padding:10px 14px;border-radius:14px;font-size:14px;}
.balance{display:flex;align-items:center;gap:10px;background:rgba(255,255,255,.08);padding:10px 14px;border-radius:14px;font-weight:700;}
.balance span{color:#22f3c8;}
.center{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;position:relative;}
.coin{width:280px;height:280px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:transform .1s ease;user-select:none;position:relative;}
.coin:active{transform:scale(.95);}
.coin img{width:100%;height:100%;object-fit:contain;user-select:none;pointer-events:none;}
.plus{position:absolute;color:#ffffff;font-weight:700;font-size:22px;animation:floatUp .9s ease forwards;pointer-events:none;}
@keyframes floatUp{from{opacity:1;transform:translateY(0)} to{opacity:0;transform:translateY(-80px)}}
.energy-boost{margin-top:26px;display:flex;gap:14px;}
.box{background:rgba(255,255,255,.08);padding:12px 18px;border-radius:14px;font-weight:600;}
.boost{ color:#ff9b2f }
.bottom{position:fixed;bottom:12px;left:12px;right:12px;background:rgba(255,255,255,.07);border-radius:18px;padding:10px;display:flex;justify-content:space-around;}
.nav{display:flex;flex-direction:column;align-items:center;gap:6px;font-size:13px;opacity:.7;}
.nav.active{opacity:1;color:#ffbf5a;}

/* ====== MAIN BOOST WINDOW (mimic image 3) ====== */
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:flex-start;justify-content:center;z-index:200;padding-top:34px;}
.modal{width:92%;max-width:640px;background:linear-gradient(180deg,#241731,#37243a);border-radius:12px;padding:18px;color:#fff;box-shadow:0 8px 40px rgba(0,0,0,.6);border:1px solid rgba(255,255,255,.03);}
/* daily boosters row (two cards) */
.daily-row{display:flex;gap:12px;margin-bottom:18px;}
.booster-card{flex:1;background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01));padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,.03);display:flex;flex-direction:column;gap:6px;min-height:64px;justify-content:center;}
.booster-card .title{font-weight:800;color:#fff;}
.booster-card .sub{color:#bfb1d8;font-size:13px;}
.section-title{font-weight:800;margin:8px 0 12px;color:#e9dff6;font-size:16px;}

/* boosters list - each row */
.boosters-list{display:flex;flex-direction:column;gap:12px;}
.booster-row{background:linear-gradient(180deg,rgba(255,255,255,.01),rgba(255,255,255,.005));padding:14px;border-radius:10px;border:1px solid rgba(255,255,255,.02);display:flex;align-items:center;justify-content:space-between;gap:12px;cursor:pointer;}
.booster-left{display:flex;gap:12px;align-items:center;}
.booster-icon{width:44px;height:44px;border-radius:10px;background:linear-gradient(180deg,#2f2340,#3b2b50);display:flex;align-items:center;justify-content:center;font-size:20px;}
.booster-info{display:flex;flex-direction:column;}
.booster-name{font-weight:700;}
.booster-price{color:#bfb1d8;font-size:13px;display:flex;align-items:center;gap:6px;}
.chev{opacity:.5}

/* ====== DETAIL MODAL (Boost x2) like image 2, with Payment button & dollar icon) ====== */
.detail-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:600;padding:20px;}
.detail-modal{width:92%;max-width:420px;background:linear-gradient(180deg,#1f1826,#2a2237);border-radius:12px;padding:22px;color:#fff;box-shadow:0 8px 40px rgba(0,0,0,.6);text-align:center;position:relative;}
.detail-modal .close-x{position:absolute;right:12px;top:12px;font-weight:700;cursor:pointer;}
.detail-modal .big-icon{width:86px;height:86px;border-radius:18px;margin:10px auto 6px;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,#31304a,#2b2340);}
.detail-modal h2{font-size:28px;margin:8px 0;}
.detail-modal p{color:#cfc1e8;font-size:14px;margin:8px 0 12px;line-height:1.5;}
.detail-price{display:flex;align-items:center;gap:8px;justify-content:center;font-weight:800;margin:12px 0;font-size:18px;}
.detail-price .currency{font-size:18px;color:#fff;}
.detail-note{color:#cfc1e8;font-size:12px;margin-bottom:10px;}
.pay-btn{background:#ffbf5a;color:#000;padding:12px 18px;border-radius:10px;border:none;cursor:pointer;font-weight:800;font-size:15px;}

/* purchase options modal (reuse styles but separate backdrop for z-index) */
.purchase-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.65);display:none;align-items:center;justify-content:center;z-index:700;padding:20px;}
.purchase-modal{width:92%;max-width:420px;background:linear-gradient(180deg,#241731,#37243a);border-radius:12px;padding:16px;color:#fff;box-shadow:0 8px 40px rgba(0,0,0,.6);}
.purchase-modal h3{margin-bottom:8px;}
.purchase-options{display:flex;flex-direction:column;gap:10px;margin-top:8px;}
.purchase-option{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:8px;background:rgba(255,255,255,.02);cursor:pointer;border:1px solid rgba(255,255,255,.02);}
.purchase-option .price{font-weight:800;color:#fff;}
.purchase-close{display:flex;justify-content:flex-end;margin-top:12px;}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,.08);color:#fff;}

/* small toast */
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:80px;background:#111;padding:10px 14px;border-radius:8px;color:#fff;box-shadow:0 6px 20px rgba(0,0,0,.6);display:none;z-index:900;}
@media (min-width:720px){ .modal{padding:22px;} .detail-modal{padding:28px;} }
</style>
</head>

<body>

<div class="top">
  <div class="wallet">üîó Connect Wallet</div>
  <div class="balance">NJR <span id="points">1525</span></div>
</div>

<div class="center">
  <div class="coin" id="coin">
    <img src="logo.png" alt="NJR">
    <div class="effect-badge" id="effectBadge" style="display:none"></div>
  </div>

  <div class="energy-boost">
    <div class="box">‚ö° <span id="energy">474</span> / <span id="maxEnergy">500</span></div>
    <div class="box boost" id="openBoostBtn">üî• Boost</div>
  </div>
</div>

<div class="bottom">
  <div class="nav active">üí∞<div>Earn</div></div>
  <div class="nav">‚úÖ<div>Tasks</div></div>
  <div class="nav">üë§<div>Account</div></div>
  <div class="nav">üí≥<div>Cashier</div></div>
</div>

<!-- MAIN BOOST WINDOW (list + daily cards) -->
<div class="modal-backdrop" id="modalBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="boostTitle">
    <div id="boostTitle" style="font-weight:800;font-size:18px;color:#fff;margin-bottom:8px;">Boosts & Purchases</div>
    <div class="small">Your daily boosters: <span id="dailyInfo">‚Äî</span></div>

    <div style="margin-top:12px;">
      <!-- Top daily cards (preserve functionality behind them) -->
      <div class="daily-row">
        <div class="booster-card" id="cardTaping" tabindex="0" role="button">
          <div class="title">üî• Taping Guru</div>
          <div class="sub">Tap multiplier √ó2 (<span id="tapingRemaining">3/3</span>)</div>
        </div>
        <div class="booster-card" id="cardFullTank" tabindex="0" role="button">
          <div class="title">‚ö° Full Tank</div>
          <div class="sub">Refills energy instantly (<span id="fullTankRemaining">3/3</span>)</div>
        </div>
      </div>

      <div class="section-title">Boosters:</div>

      <div class="boosters-list">
        <!-- Boost X2 (clicking opens detail modal like image 2) -->
        <div class="booster-row" id="listBoostX2" data-item="boostx2" tabindex="0" role="button">
          <div class="booster-left">
            <div class="booster-icon">üöÄ</div>
            <div class="booster-info">
              <div class="booster-name">Boost X2</div>
              <div class="booster-price"><span class="price-amount">400</span> <span style="color:#22f3c8">üíé</span></div>
            </div>
          </div>
          <div class="chev">‚Ä∫</div>
        </div>

        <div class="booster-row" data-item="multitap" tabindex="0" role="button">
          <div class="booster-left">
            <div class="booster-icon">‚úã</div>
            <div class="booster-info">
              <div class="booster-name">Multitap</div>
              <div class="booster-price">200 <span style="opacity:.7">‚Ä¢ 1 level</span></div>
            </div>
          </div>
          <div class="chev">‚Ä∫</div>
        </div>

        <div class="booster-row" data-item="energylimit" tabindex="0" role="button">
          <div class="booster-left">
            <div class="booster-icon">üîã</div>
            <div class="booster-info">
              <div class="booster-name">Energy Limit</div>
              <div class="booster-price">200 <span style="opacity:.7">‚Ä¢ 1 level</span></div>
            </div>
          </div>
          <div class="chev">‚Ä∫</div>
        </div>

        <div class="booster-row" data-item="recharge" tabindex="0" role="button">
          <div class="booster-left">
            <div class="booster-icon">‚ö°</div>
            <div class="booster-info">
              <div class="booster-name">Recharging Speed</div>
              <div class="booster-price">2 000 <span style="opacity:.7">‚Ä¢ 1 level</span></div>
            </div>
          </div>
          <div class="chev">‚Ä∫</div>
        </div>

        <div class="booster-row" data-item="tapbot" tabindex="0" role="button">
          <div class="booster-left">
            <div class="booster-icon">ü§ñ</div>
            <div class="booster-info">
              <div class="booster-name">Tap Bot</div>
              <div class="booster-price">200 000</div>
            </div>
          </div>
          <div class="chev">‚Ä∫</div>
        </div>
      </div>

      <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end;">
        <button class="btn ghost" id="closeModal">Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- DETAIL MODAL for Boost X2 (like image 2) -->
<div class="detail-backdrop" id="detailBackdrop" aria-hidden="true">
  <div class="detail-modal" role="dialog" aria-modal="true" aria-labelledby="detailTitle">
    <div class="close-x" id="closeDetail">‚úï</div>
    <div class="big-icon">üöÄ</div>
    <h2 id="detailTitle">Boost x2</h2>
    <p>Take advantage of this limited-time offer to boost your productivity. Purchase this boost to permanently multiply your tap and bot income by x2.</p>

    <!-- Price shown with a dollar icon (user requested dollar instead of gems on this modal) -->
    <div class="detail-price"><span class="currency">üíµ</span> <span id="detailPrice">400</span></div>
    <div class="detail-note" id="detailNote">insufficient funds</div>

    <!-- Payment button (yellow) - user asked label "Payment" not "GET GEMS" -->
    <button class="pay-btn" id="paymentBtn">Payment</button>
  </div>
</div>

<!-- PURCHASE OPTIONS modal (opens when pressing Payment) -->
<div class="purchase-backdrop" id="purchaseBackdrop" aria-hidden="true">
  <div class="purchase-modal" role="dialog" aria-modal="true" aria-labelledby="purchaseTitle">
    <h3 id="purchaseTitle">Boost √ó2 ‚Äî Purchase duration</h3>
    <div class="purchase-options" id="purchaseOptionsContainer">
      <!-- options will be rendered here (we keep same options from your code) -->
      <div class="purchase-option" data-price="0.5" data-duration="3600"><div>√ó2 ‚Äî 1 hour</div><div class="price">$0.5</div></div>
      <div class="purchase-option" data-price="1" data-duration="14400"><div>√ó2 ‚Äî 4 hours</div><div class="price">$1</div></div>
      <div class="purchase-option" data-price="4" data-duration="28800"><div>√ó2 ‚Äî 8 hours</div><div class="price">$4</div></div>
    </div>

    <div class="purchase-close">
      <button class="btn ghost" id="closePurchase">Cancel</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
const tg = window.Telegram.WebApp;
tg.ready();

const userId = tg.initDataUnsafe?.user?.id || "guest";
let energy=0, maxEnergy=500, points=0, boost=1;
let displayedEnergy=0, displayedPoints=0;
let pendingGain=0;
let initialLoaded=false;

// activeEffects from server: {type:"taping"|"x2", expires_at: timestamp (ms)}
let activeEffects = [];
let localMultiplier = 1; // used for client immediate tap multiplier

// helper: toast
function showToast(msg, timeout=2000){
  const t = document.getElementById("toast");
  t.innerText = msg;
  t.style.display = "block";
  clearTimeout(t._to);
  t._to = setTimeout(()=> t.style.display = "none", timeout);
}

// animate number
function animateNumber(from,to,onStep,duration=400){
  if(from===to){ onStep(to); return Promise.resolve(); }
  return new Promise(resolve=>{
    const start = performance.now();
    const sign = to>from?1:-1;
    const range = Math.abs(to-from);
    function step(now){
      const t = Math.min(1,(now-start)/duration);
      const eased = 1 - Math.pow(1 - t, 2);
      const current = from + sign * Math.round(range * eased);
      onStep(current);
      if(t<1) requestAnimationFrame(step);
      else { onStep(to); resolve(); }
    }
    requestAnimationFrame(step);
  });
}

function updateUI(){
  document.getElementById("energy").innerText = Math.max(0, Math.floor(displayedEnergy));
  document.getElementById("maxEnergy").innerText = maxEnergy;
  document.getElementById("points").innerText = Math.floor(displayedPoints);
}

// ====== state polling (keeps server authoritative values & active effects) ======
let pollInterval = 2000; let pollTimer=null;
async function fetchStateOnce(){
  try{
    const r = await fetch(`/state/${userId}`);
    return await r.json();
  }catch(e){ console.warn("state fetch failed",e); return null; }
}

async function pollState(){
  const data = await fetchStateOnce();
  if(!data || !data.success) return;
  const prevPoints = points;
  energy = data.energy; maxEnergy = data.maxEnergy; points = data.points;
  activeEffects = (data.active_effects || []).map(e=> ({...e, expires_at: e.expires_at}));
  const confirmedGain = Math.max(0, points - prevPoints);
  pendingGain = Math.max(0, pendingGain - confirmedGain);
  const targetDisplayedPoints = points + pendingGain;
  if(!initialLoaded){
    displayedEnergy = energy; displayedPoints = targetDisplayedPoints; initialLoaded=true; updateUI();
  } else {
    animateNumber(displayedEnergy, energy, v=>{ displayedEnergy = v; updateUI(); }, 300);
    animateNumber(displayedPoints, targetDisplayedPoints, v=>{ displayedPoints = v; updateUI(); }, 300);
  }
  const now = Date.now();
  const tapEffect = activeEffects.find(e=> e.type === 'taping' && e.expires_at > now);
  const x2Effect = activeEffects.find(e=> e.type === 'x2' && e.expires_at > now);
  localMultiplier = (tapEffect || x2Effect) ? 2 : 1;
}

function startPolling(){
  if(pollTimer) return;
  pollState();
  pollTimer = setInterval(pollState, pollInterval);
  document.addEventListener('visibilitychange', ()=>{
    if(document.hidden){ clearInterval(pollTimer); pollTimer=null; }
    else startPolling();
  });
}
startPolling();

// send heartbeat to mark daily/online activity
async function sendHeartbeat() {
  if (!userId || String(userId) === 'guest') return;
  try {
    await fetch(`/heartbeat/${userId}`, { method: 'POST' });
  } catch (e) {
    console.warn('heartbeat failed', e);
  }
}
sendHeartbeat();

// ====== BOOST modal behavior & preserving original top-buttons functionality ======
const modalBackdrop = document.getElementById("modalBackdrop");
const tapingRemainingEl = document.getElementById('tapingRemaining');
const fullTankRemainingEl = document.getElementById('fullTankRemaining');

document.getElementById("openBoostBtn").addEventListener("click", ()=> {
  fetch(`/daily-info/${userId}`).then(r=>r.json()).then(d=>{
    if(d?.success){
      const tapUsed = d.taping_used || 0;
      const ftUsed = d.fulltank_used || 0;
      const tapRem = Math.max(0, 3 - tapUsed);
      const ftRem = Math.max(0, 3 - ftUsed);
      document.getElementById("dailyInfo").innerText = `Taping ${tapRem}/3 ¬∑ FullTank ${ftRem}/3`;
      tapingRemainingEl.innerText = `${tapRem}/3`;
      fullTankRemainingEl.innerText = `${ftRem}/3`;
    } else {
      document.getElementById("dailyInfo").innerText = `Taping 3/3 ¬∑ FullTank 3/3`;
      tapingRemainingEl.innerText = `3/3`;
      fullTankRemainingEl.innerText = `3/3`;
    }
    modalBackdrop.style.display = "flex";
    modalBackdrop.setAttribute('aria-hidden','false');
  }).catch(()=>{
    modalBackdrop.style.display="flex";
    tapingRemainingEl.innerText = `3/3`;
    fullTankRemainingEl.innerText = `3/3`;
    document.getElementById("dailyInfo").innerText = `Taping 3/3 ¬∑ FullTank 3/3`;
    modalBackdrop.setAttribute('aria-hidden','false');
  });
});
document.getElementById("closeModal").addEventListener("click", ()=> {
  modalBackdrop.style.display="none";
  modalBackdrop.setAttribute('aria-hidden','true');
});

// Make the top daily cards keep original functionality
document.getElementById('cardFullTank').addEventListener('click', async ()=>{
  // reuse original full tank activation flow
  try {
    const res = await fetch("/boost/full", {method:"POST",headers:{"Content-Type":"application/json"}, body: JSON.stringify({user_id:userId})});
    const data = await res.json();
    if(!data.success){ showToast(data.message || 'Activation failed'); return; }
    energy = data.energy; points = data.points || points;
    pendingGain = 0;
    animateNumber(displayedEnergy, energy, v=>{ displayedEnergy=v; updateUI(); }, 300);
    animateNumber(displayedPoints, points, v=>{ displayedPoints=v; updateUI(); }, 300);
    if(typeof data.fulltank_used !== 'undefined'){
      const rem = Math.max(0, 3 - data.fulltank_used);
      fullTankRemainingEl.innerText = `${rem}/3`;
      document.getElementById("dailyInfo").innerText = `Taping ${tapingRemainingEl.innerText} ¬∑ FullTank ${fullTankRemainingEl.innerText}`;
    }
    modalBackdrop.style.display = "none";
    modalBackdrop.setAttribute('aria-hidden','true');
  } catch (err) {
    console.warn("Full Tank activation error", err);
  }
});

document.getElementById('cardTaping').addEventListener('click', async ()=>{
  try {
    const res = await fetch("/boost/taping", {method:"POST",headers:{"Content-Type":"application/json"}, body: JSON.stringify({user_id:userId})});
    const data = await res.json();
    if(!data.success){ showToast(data.message || 'Activation failed'); return; }
    // apply immediate local multiplier for responsiveness
    localMultiplier = 2;
    if(typeof data.taping_used !== 'undefined'){
      const rem = Math.max(0, 3 - data.taping_used);
      tapingRemainingEl.innerText = `${rem}/3`;
      document.getElementById("dailyInfo").innerText = `Taping ${tapingRemainingEl.innerText} ¬∑ FullTank ${fullTankRemainingEl.innerText}`;
    }
    modalBackdrop.style.display = "none";
    modalBackdrop.setAttribute('aria-hidden','true');
  } catch (err) {
    console.warn("Taping activation error", err);
  }
});

// Also keep original buttons inside main modal (for accessibility)
document.getElementById('btnFullTank')?.addEventListener('click', ()=> document.getElementById('cardFullTank').click());
document.getElementById('btnTaping')?.addEventListener('click', ()=> document.getElementById('cardTaping').click());

// ====== List item -> open detail modal (Boost X2) ======
const listBoostX2 = document.getElementById('listBoostX2');
const detailBackdrop = document.getElementById('detailBackdrop');
const detailPriceEl = document.getElementById('detailPrice');
const detailNoteEl = document.getElementById('detailNote');
const paymentBtn = document.getElementById('paymentBtn');

listBoostX2.addEventListener('click', ()=> {
  // show detail modal similar to image 2
  // Show the "price" as the gem-count by default (we display number) but with dollar icon per user's request on this modal
  // The backend may store gem price 400; we show the number here. The Payment flow will use dollar-based purchases.
  const gemAmount = listBoostX2.querySelector('.price-amount')?.innerText || '400';
  detailPriceEl.innerText = gemAmount;
  detailNoteEl.innerText = 'insufficient funds';
  detailBackdrop.style.display = 'flex';
  detailBackdrop.setAttribute('aria-hidden','false');
});

// close detail
document.getElementById('closeDetail').addEventListener('click', ()=> {
  detailBackdrop.style.display = 'none';
  detailBackdrop.setAttribute('aria-hidden','true');
});
detailBackdrop.addEventListener('click', (e)=> { if(e.target === detailBackdrop){ detailBackdrop.style.display='none'; detailBackdrop.setAttribute('aria-hidden','true'); } });

// When clicking Payment open purchase options (user requested yellow button named Payment and dollar instead of gems)
const purchaseBackdrop = document.getElementById('purchaseBackdrop');
const purchaseOptionsContainer = document.getElementById('purchaseOptionsContainer');

paymentBtn.addEventListener('click', ()=> {
  // close detail and open purchase options
  detailBackdrop.style.display = 'none';
  detailBackdrop.setAttribute('aria-hidden','true');
  purchaseBackdrop.style.display = 'flex';
  purchaseBackdrop.setAttribute('aria-hidden','false');
});

// Close purchase
document.getElementById('closePurchase').addEventListener('click', ()=> {
  purchaseBackdrop.style.display = 'none';
  purchaseBackdrop.setAttribute('aria-hidden','true');
});

// Purchase options click -> create invoice etc. (keeps your existing purchase logic, but in dollars)
document.querySelectorAll('.purchase-option').forEach(opt=>{
  opt.addEventListener('click', async ()=>{
    const price = parseFloat(opt.dataset.price);
    const duration = parseInt(opt.dataset.duration,10);
    showToast("Creating invoice...");
    try {
      const r = await fetch("/purchase", {method:"POST",headers:{"Content-Type":"application/json"}, body: JSON.stringify({ user_id: userId, price, duration, currency: 'USD', item: 'boost_x2' })});
      const j = await r.json();
      if(!j.success){ showToast(j.message || "Invoice creation error"); return; }
      if(j.payment_url){
        // open payment in new tab; Telegram WebApp may have its own payment method, but we fallback to opening URL
        window.open(j.payment_url, "_blank");
      }
      showToast("Waiting for payment confirmation...");
      const purchaseId = j.purchase_id;
      const start = Date.now();
      const timeout = 2*60*1000; // 2 minutes
      const poll = setInterval(async ()=>{
        try {
          const sres = await fetch(`/purchase/status/${purchaseId}`);
          const sj = await sres.json();
          if(sj.success && sj.status === 'paid'){
            clearInterval(poll);
            showToast("Payment confirmed. √ó2 activated");
            await pollState(); // force refresh from server
            purchaseBackdrop.style.display = 'none';
            purchaseBackdrop.setAttribute('aria-hidden','true');
          } else if(Date.now() - start > timeout){
            clearInterval(poll);
            showToast("Payment time expired or the user did not complete the payment");
          }
        } catch(e){
          console.warn('purchase status poll failed', e);
        }
      }, 2000);
    } catch(e){
      console.warn('purchase creation failed', e);
      showToast("Failed to create purchase");
    }
  });
});

/* ====== TAP logic (unchanged) ====== */
const coin = document.getElementById("coin");
coin.addEventListener("click", (e)=>{
  if(Math.floor(displayedEnergy) <= 0) return;
  const p = document.createElement("div");
  p.className = "plus";
  const value = boost * localMultiplier;
  p.innerText = `+${value}`;
  p.style.left = `${e.clientX}px`;
  p.style.top = `${e.clientY}px`;
  p.style.transform = 'translate(-50%,-50%)';
  p.style.position = 'fixed';
  document.body.appendChild(p);
  setTimeout(()=>p.remove(),900);
  if(navigator.vibrate) navigator.vibrate(20);

  displayedEnergy = Math.max(0, displayedEnergy - 1);
  pendingGain += value;
  displayedPoints = points + pendingGain;
  updateUI();

  fetch("/tap", {method:"POST",headers:{"Content-Type":"application/json"},body: JSON.stringify({user_id:userId})})
    .then(r=>r.json())
    .then(data=>{
      if(!data.success){
        pollState();
        return;
      }
      energy = data.energy;
      points += data.gain;
      pendingGain = Math.max(0, pendingGain - data.gain);
      animateNumber(displayedEnergy, energy, v=>{ displayedEnergy=v; updateUI(); }, 300);
      animateNumber(displayedPoints, points + pendingGain, v=>{ displayedPoints=v; updateUI(); }, 300);
    }).catch(err=>{
      console.warn("tap error",err);
      pollState();
    });
});

// start
updateUI();
</script>

<!-- APPEND: Account panel (unchanged) -->
<style>
/* Account panel styles (scoped) */
.account-panel-backdrop{
  position:fixed;inset:0;display:none;align-items:flex-start;justify-content:center;
  padding-top:40px;z-index:400;background:linear-gradient(180deg,rgba(6,6,7,.45),rgba(6,6,7,.7));
  backdrop-filter: blur(6px);
}
.account-panel{
  width:92%;max-width:520px;margin:0 auto;background:linear-gradient(180deg,#241d2b,#2d2436);
  border-radius:14px;padding:14px 14px 20px;color:#fff;box-shadow:0 12px 40px rgba(0,0,0,.6);
  border:1px solid rgba(255,255,255,.03);
  font-family: 'Poppins', system-ui;
}
.account-top-tabs{display:flex;gap:8px;background:rgba(255,255,255,.02);padding:8px;border-radius:12px;align-items:center;justify-content:center;margin-bottom:12px;}
.account-tab-btn{flex:1;padding:8px 12px;border-radius:10px;text-align:center;color:#cfc1e8;font-weight:600;cursor:pointer;border:1px solid transparent;}
.account-tab-btn.active{background:linear-gradient(180deg,#3a2f48,#442f53);color:#fff;border:1px solid rgba(255,255,255,.04);box-shadow:0 6px 18px rgba(0,0,0,.45);}
.account-section{padding:8px 6px;min-height:220px;}
.account-stats{display:flex;flex-direction:column;gap:18px;align-items:center;padding-top:6px;}
.stat-row{text-align:center;}
.stat-title{color:#bfb1d8;font-size:13px;margin-bottom:6px;}
.stat-value{font-weight:800;font-size:22px;letter-spacing:2px;color:#fff;text-shadow:0 6px 18px rgba(0,0,0,.6);}
/* small tweaks */
.close-panel{position:absolute;right:18px;top:12px;color:#cfc1e8;cursor:pointer;font-weight:700;}
.no-ref{padding:24px 6px;text-align:center;color:#d6cfe6;}
.account-small{font-size:13px;color:#bfb1d8;margin-bottom:6px;}
@media (min-width:720px){ .account-panel{margin-top:48px;} }
</style>

<div class="account-panel-backdrop" id="accountPanelBackdrop" aria-hidden="true">
  <div class="account-panel" role="dialog" aria-modal="true" aria-labelledby="accountTitle">
    <div style="position:relative;">
      <div id="accountTitle" style="font-weight:800;font-size:16px;color:#fff;margin-bottom:8px;">Account</div>
      <div class="close-panel" id="closeAccountPanel" role="button" tabindex="0">‚úï</div>
    </div>

    <div class="account-top-tabs" role="tablist" aria-label="Account tabs">
      <div class="account-tab-btn" data-tab="ref">Ref</div>
      <div class="account-tab-btn active" data-tab="stats">Stats</div>
      <div class="account-tab-btn" data-tab="settings">Settings</div>
    </div>

    <div class="account-section" id="accountSection">
      <!-- STATS (default active) -->
      <div class="account-content" data-content="stats" style="display:block;">
        <div class="account-stats">
          <div class="stat-row">
            <div class="stat-title">Total Share Balance:</div>
            <div class="stat-value" id="statShare">‚Äî</div>
          </div>
          <div class="stat-row">
            <div class="stat-title">Total Touches:</div>
            <div class="stat-value" id="statTouches">‚Äî</div>
          </div>
          <div class="stat-row">
            <div class="stat-title">Total Players:</div>
            <div class="stat-value" id="statPlayers">‚Äî</div>
          </div>
          <div class="stat-row">
            <div class="stat-title">Daily Users:</div>
            <div class="stat-value" id="statDaily">‚Äî</div>
          </div>
          <div class="stat-row">
            <div class="stat-title">Online Players:</div>
            <div class="stat-value" id="statOnline">‚Äî</div>
          </div>
        </div>
      </div>

      <!-- REF -->
      <div class="account-content" data-content="ref" style="display:none;">
        <div class="account-small">My ref bonus: <span id="myRefBonus">0</span></div>
        <div class="account-small">My ref: <span id="myRefCount">0</span></div>

        <div class="invite-card" style="margin-top:8px;">
          <div class="invite-left">
            <div class="invite-label">My invite link:</div>
            <div class="invite-link" id="inviteLink">‚Äî</div>
          </div>
          <div>
            <button class="copy-btn" id="copyInviteBtn">Copy</button>
          </div>
        </div>

        <div class="ref-list">
          <div style="font-weight:800;margin-top:12px;">My Referals list:</div>
          <div class="no-ref" id="noRefText">You don't have referrals üò≠</div>
          <div id="refListContainer" style="display:none;"></div>
        </div>
      </div>

      <!-- SETTINGS -->
      <div class="account-content" data-content="settings" style="display:none;">
        <div class="settings-list">
          <div class="settings-item" role="button" id="privacyBtn">Privacy Policy <span>‚Ä∫</span></div>
          <div class="settings-item" role="button" id="termsBtn">Terms of Use <span>‚Ä∫</span></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* Account panel behavior (uses existing userId variable from your script) */
(function(){
  const backdrop = document.getElementById('accountPanelBackdrop');
  const closeBtn = document.getElementById('closeAccountPanel');
  const tabs = document.querySelectorAll('.account-tab-btn');
  const contents = document.querySelectorAll('.account-content');

  const myRefCountEl = document.getElementById('myRefCount');
  const myRefBonusEl = document.getElementById('myRefBonus');
  const refListContainer = document.getElementById('refListContainer');
  const noRefText = document.getElementById('noRefText');

  const accountNav = document.querySelector('.bottom .nav:nth-child(3)');
  if(accountNav){
    accountNav.addEventListener('click', ()=> openAccountPanel());
  }

  async function openAccountPanel(){
    try { if (typeof userId !== 'undefined' && String(userId) !== 'guest') await fetch(`/heartbeat/${userId}`, { method: 'POST' }); } catch(e){}
    const inviteEl = document.getElementById('inviteLink');
    try{
      const botUsername = 'NJROfficialBot';
      const uid = (typeof userId !== 'undefined') ? userId : 'guest';
      const link = `https://t.me/${botUsername}?start=r_${uid}`;
      inviteEl.innerText = link;
      inviteEl.setAttribute('data-link', link);
    }catch(e){
      inviteEl.innerText = 'https://t.me/YOUR-BOT?start=r_XXXXX';
    }

    try {
      const gres = await fetch('/global-stats');
      const g = await gres.json();
      if (g && g.success) {
        document.getElementById('statShare').innerText = (g.total_share_balance || 0).toLocaleString();
        document.getElementById('statTouches').innerText = (g.total_touches || 0).toLocaleString();
        document.getElementById('statPlayers').innerText = (g.total_players || 0).toLocaleString();
        document.getElementById('statDaily').innerText = (g.daily_users || 0).toLocaleString();
        document.getElementById('statOnline').innerText = (g.online_players || 0).toLocaleString();
      } else {
        document.getElementById('statShare').innerText = '9710702162713';
        document.getElementById('statTouches').innerText = '106 056 491 953';
        document.getElementById('statPlayers').innerText = '74 839 124';
        document.getElementById('statDaily').innerText = '22 010';
        document.getElementById('statOnline').innerText = '318';
      }
    } catch (err) {
      console.warn('global-stats fetch failed', err);
      document.getElementById('statShare').innerText = '9710702162713';
      document.getElementById('statTouches').innerText = '106 056 491 953';
      document.getElementById('statPlayers').innerText = '74 839 124';
      document.getElementById('statDaily').innerText = '22 010';
      document.getElementById('statOnline').innerText = '318';
    }

    try {
      if (typeof userId !== 'undefined' && userId && String(userId) !== 'guest') {
        const res = await fetch(`/ref/${userId}`);
        const j = await res.json();
        if (j && j.success) {
          myRefCountEl.innerText = j.referrals_count || 0;
          myRefBonusEl.innerText = j.ref_bonus_total || 0;
          if (Array.isArray(j.referrals) && j.referrals.length > 0) {
            refListContainer.innerHTML = ''; refListContainer.style.display = 'block'; noRefText.style.display = 'none';
            j.referrals.forEach(r => {
              const item = document.createElement('div');
              item.style.padding = '8px 6px';
              item.style.borderBottom = '1px solid rgba(255,255,255,.02)';
              item.style.display = 'flex';
              item.style.justifyContent = 'space-between';
              item.style.alignItems = 'center';
              const left = document.createElement('div');
              left.style.fontWeight = '700';
              left.style.color = '#fff';
              left.innerText = r.uid;
              const right = document.createElement('div');
              right.style.fontSize = '12px';
              right.style.color = '#cfc1e8';
              right.innerText = r.at ? new Date(r.at).toLocaleString() : '';
              item.appendChild(left);
              item.appendChild(right);
              refListContainer.appendChild(item);
            });
          } else {
            refListContainer.style.display = 'none';
            noRefText.style.display = 'block';
          }
        } else {
          myRefCountEl.innerText = '0';
          myRefBonusEl.innerText = '0';
          refListContainer.style.display = 'none';
          noRefText.style.display = 'block';
        }
      } else {
        myRefCountEl.innerText = '0';
        myRefBonusEl.innerText = '0';
        refListContainer.style.display = 'none';
        noRefText.style.display = 'block';
      }
    } catch (err) {
      console.warn("Failed to fetch ref info", err);
      myRefCountEl.innerText = '0';
      myRefBonusEl.innerText = '0';
      refListContainer.style.display = 'none';
      noRefText.style.display = 'block';
    }

    backdrop.style.display = 'flex';
    backdrop.setAttribute('aria-hidden','false');
  }

  function closePanel(){
    backdrop.style.display = 'none';
    backdrop.setAttribute('aria-hidden','true');
  }

  closeBtn.addEventListener('click', closePanel);
  backdrop.addEventListener('click', (e)=>{ if(e.target === backdrop) closePanel(); });

  tabs.forEach(t=>{
    t.addEventListener('click', ()=>{
      tabs.forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      const target = t.getAttribute('data-tab');
      contents.forEach(c=>{
        if(c.getAttribute('data-content') === target) c.style.display = 'block';
        else c.style.display = 'none';
      });
    });
  });

  const copyBtn = document.getElementById('copyInviteBtn');
  copyBtn.addEventListener('click', async ()=>{
    const link = document.getElementById('inviteLink').getAttribute('data-link') || document.getElementById('inviteLink').innerText;
    try{
      await navigator.clipboard.writeText(link);
      if(typeof showToast === 'function') showToast('Invite link copied');
      else alert('Invite link copied');
    }catch(e){
      if(typeof showToast === 'function') showToast('Copy failed');
      else alert('Copy failed');
    }
  });

  document.getElementById('privacyBtn').addEventListener('click', ()=>{ 
    if(typeof showToast === 'function') showToast('Open Privacy Policy');
    const evt = new Event('openPrivacy');
    document.dispatchEvent(evt);
  });
  document.getElementById('termsBtn').addEventListener('click', ()=>{ 
    if(typeof showToast === 'function') showToast('Open Terms of Use');
    const evt = new Event('openTerms');
    document.dispatchEvent(evt);
  });
})();
</script>
<!-- END APPEND -->

<!-- APPEND: Privacy & Terms viewer (unchanged) -->
<style>
.policy-backdrop{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:700;padding:20px;backdrop-filter:blur(6px);}
.policy-modal{width:92%;max-width:760px;max-height:86vh;overflow:auto;background:linear-gradient(180deg,#1f1826,#2a2237);border-radius:12px;padding:18px 18px 22px;color:#fff;box-shadow:0 12px 40px rgba(0,0,0,.6);border:1px solid rgba(255,255,255,.03);font-family:'Poppins',system-ui;}
.policy-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;}
.policy-title{font-weight:800;font-size:18px;color:#fff;}
.policy-close{background:transparent;border:1px solid rgba(255,255,255,.04);color:#cfc1e8;padding:6px 10px;border-radius:8px;cursor:pointer;}
.policy-content{font-size:14px;line-height:1.6;color:#e6dff6;}
.policy-section{margin-top:10px;margin-bottom:10px;}
.policy-small{font-size:13px;color:#bfb1d8;margin-top:8px;}
.policy-content p{margin:8px 0;}
</style>

<div class="policy-backdrop" id="policyBackdrop" aria-hidden="true">
  <div class="policy-modal" role="dialog" aria-modal="true" aria-labelledby="policyTitle">
    <div class="policy-header">
      <div id="policyTitle" class="policy-title">Policy</div>
      <button class="policy-close" id="closePolicyBtn">ÿ•ÿ∫ŸÑÿßŸÇ</button>
    </div>
    <div class="policy-content" id="policyContent" tabindex="0"></div>
  </div>
</div>

<script>
// Policy viewer behavior (unchanged)
(function(){
  const backdrop = document.getElementById('policyBackdrop');
  const contentEl = document.getElementById('policyContent');
  const titleEl = document.getElementById('policyTitle');
  const closeBtn = document.getElementById('closePolicyBtn');

  const PRIVACY_HTML = `...`; // trimmed for brevity
  const TERMS_HTML = `...`; // trimmed for brevity

  function openPolicy(title, html){
    titleEl.innerText = title;
    contentEl.innerHTML = html;
    backdrop.style.display = 'flex';
    backdrop.setAttribute('aria-hidden','false');
    contentEl.focus();
  }
  function closePolicy(){
    backdrop.style.display = 'none';
    backdrop.setAttribute('aria-hidden','true');
    contentEl.innerHTML = '';
  }

  const privacyBtn = document.getElementById('privacyBtn');
  const termsBtn = document.getElementById('termsBtn');

  if(privacyBtn){
    privacyBtn.addEventListener('click', ()=> { openPolicy('Privacy Policy ‚Äî NJR', PRIVACY_HTML); });
  }
  if(termsBtn){
    termsBtn.addEventListener('click', ()=> { openPolicy('Terms of Use ‚Äî NJR', TERMS_HTML); });
  }

  closeBtn.addEventListener('click', closePolicy);
  backdrop.addEventListener('click', (e)=>{ if(e.target === backdrop) closePolicy(); });
  document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape' && backdrop.style.display === 'flex') closePolicy(); });
  document.addEventListener('openPrivacy', ()=> openPolicy('Privacy Policy ‚Äî NJR', PRIVACY_HTML));
  document.addEventListener('openTerms', ()=> openPolicy('Terms of Use ‚Äî NJR', TERMS_HTML));
})();
</script>
<!-- END APPEND -->

</body>
</html>
